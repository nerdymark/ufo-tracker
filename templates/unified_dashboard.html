<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛸 UFO Tracker - Unified Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000814;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 10px;
            position: relative;
            overflow-x: hidden;
        }

        /* Starfield Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent),
                radial-gradient(1px 1px at 200px 90px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 240px 20px, #fff, transparent),
                radial-gradient(2px 2px at 280px 100px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 320px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 360px 120px, #fff, transparent);
            background-repeat: repeat;
            background-size: 400px 400px;
            animation: starMove 120s linear infinite;
            z-index: -3;
            opacity: 0.6;
        }

        @keyframes starMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-200px, -200px); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 8, 20, 0.85);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 150, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 
                0 0 10px rgba(100, 200, 255, 0.5),
                0 0 20px rgba(100, 200, 255, 0.3),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            background: linear-gradient(45deg, #64c8ff, #ffffff, #64c8ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #a0c4ff;
            text-shadow: 0 0 5px rgba(160, 196, 255, 0.3);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 5px;
            gap: 5px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* System Status Panel */
        .status-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-5px);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }

        .status-active { background: #4CAF50; }
        .status-inactive { background: #f44336; }
        .status-updating { background: #ff9800; animation: pulse 1s infinite; }

        /* Status Bar (Always Visible) */
        .status-bar {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-grid-horizontal {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            justify-content: space-between;
        }

        .status-item-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 14px;
        }

        .status-label {
            font-weight: bold;
            min-width: 50px;
        }

        .status-indicator-small {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .btn-small {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Camera Grid */
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .camera-panel {
            background: rgba(0, 8, 20, 0.75);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 32px rgba(0, 150, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Auto Tracking Styles */
        .tracking-status-panel {
            background: rgba(0, 20, 8, 0.75);
            border: 1px solid rgba(100, 255, 150, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 32px rgba(0, 255, 100, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .tracking-controls {
            margin-bottom: 15px;
        }

        .tracking-status .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .status-label {
            font-size: 0.9rem;
            color: #a0c4ff;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #64c8ff;
        }

        .tracking-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            color: #a0c4ff;
            font-size: 0.8rem;
        }

        .info-value {
            color: #64c8ff;
            font-weight: bold;
            margin-top: 2px;
        }

        .tracking-settings-panel {
            background: rgba(8, 0, 20, 0.75);
            border: 1px solid rgba(200, 100, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(15px);
        }

        /* Feature Tracking Styles */
        .feature-tracking-description {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .feature-frame-container {
            margin: 15px 0;
            border: 2px dashed rgba(100, 200, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        .feature-tracking-canvas {
            display: block;
            max-width: 100%;
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 4px;
            cursor: crosshair;
            background: #000;
        }

        .feature-tracking-canvas:hover {
            border-color: rgba(100, 200, 255, 0.5);
        }

        .feature-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .feature-status.status-good {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .feature-status.status-waiting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .feature-status.status-active {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .feature-instructions {
            background: rgba(23, 162, 184, 0.1);
            border: 1px solid rgba(23, 162, 184, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 14px;
        }

        .feature-instructions p {
            margin: 5px 0;
            color: #e0e0e0;
        }

        .feature-instructions strong {
            color: #64c8ff;
        }

        .feature-camera-btn.active {
            background: rgba(23, 162, 184, 0.3);
            border-color: #17a2b8;
            color: #17a2b8;
        }

        /* Detection Statistics */
        .detection-stat {
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .detection-stat .value {
            font-size: 24px;
            font-weight: bold;
            color: #64c8ff;
            display: block;
        }

        .detection-stat .label {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .gallery-item {
            background: rgba(8, 0, 20, 0.75);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .gallery-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .gallery-item-info {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .gallery-item-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }

        .camera-preview {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .camera-preview img:hover {
            transform: scale(1.02);
        }

        .camera-preview img:fullscreen {
            object-fit: contain;
            background: black;
        }

        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .live-indicator {
            color: #00ff00;
            font-weight: bold;
            animation: pulse 2s infinite;
            font-size: 0.9rem;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Control Groups */
        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .control-input {
            width: 100%;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 0 15px;
            font-size: 1rem;
        }

        .control-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .range-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .range-display span:nth-child(2) {
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
            backdrop-filter: blur(10px);
            /* Prevent double-tap zoom on mobile devices */
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.8), rgba(69, 160, 73, 0.8));
            color: #e0e0e0;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.8), rgba(25, 118, 210, 0.8));
            color: #e0e0e0;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .btn-warning {
            background: linear-gradient(45deg, rgba(255, 152, 0, 0.8), rgba(245, 124, 0, 0.8));
            color: #e0e0e0;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, rgba(244, 67, 54, 0.8), rgba(211, 47, 47, 0.8));
            color: #e0e0e0;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 4px 15px rgba(100, 200, 255, 0.2),
                0 0 20px rgba(100, 200, 255, 0.4);
            border-color: rgba(100, 200, 255, 0.6);
        }
        
        .btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #555 !important;
            color: #999 !important;
            border-color: #444 !important;
        }
        
        .btn.disabled:hover {
            background: #555 !important;
            color: #999 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Checkbox Styling */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
        }

        /* Music Effects Controls */
        .effect-control {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
        }
        
        .effect-control .checkbox-group {
            margin-bottom: 8px;
        }
        
        .effect-control input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        .effect-value {
            font-size: 12px;
            color: #64c8ff;
            font-weight: bold;
            float: right;
        }

        /* Detection Panel */
        .detection-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .detection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detection-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .detection-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .detection-stat .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Image Browser Styles */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
        }

        .image-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .image-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .image-info {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 8px;
        }

        .image-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .image-type.motion_detection { background: #4CAF50; color: white; }
        .image-type.stacked { background: #2196F3; color: white; }
        .image-type.aligned { background: #FF9800; color: white; }
        .image-type.unknown { background: #757575; color: white; }

        .image-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-tiny {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-tiny.view { background: #4CAF50; color: white; }
        .btn-tiny.delete { background: #f44336; color: white; }
        .btn-tiny:hover { opacity: 0.8; }

        .loading-message {
            text-align: center;
            color: #ccc;
            padding: 20px;
            grid-column: 1 / -1;
        }

        /* Timelapse Styles */
        .timelapse-controls h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .timelapse-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .timelapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timelapse-title {
            font-weight: bold;
            color: #4CAF50;
        }

        .timelapse-info {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 8px;
        }

        .timelapse-actions {
            display: flex;
            gap: 8px;
        }

        .timelapse-video {
            width: 100%;
            max-width: 400px;
            height: 225px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .timelapse-empty {
            text-align: center;
            color: #888;
            padding: 20px;
            font-style: italic;
        }

        .storage-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                min-width: auto;
            }

            .camera-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                min-width: auto;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .detection-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }

            .camera-panel,
            .status-panel,
            .detection-panel {
                padding: 15px;
            }

            .detection-info {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error Messages - Fixed overlay positioning */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            max-width: 400px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.95), rgba(76, 175, 80, 0.85));
            border: 1px solid rgba(76, 175, 80, 0.8);
            color: #ffffff;
        }

        .message.error {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.95), rgba(244, 67, 54, 0.85));
            border: 1px solid rgba(244, 67, 54, 0.8);
            color: #ffffff;
        }
        
        .message.info {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.95), rgba(33, 150, 243, 0.85));
            border: 1px solid rgba(33, 150, 243, 0.8);
            color: #ffffff;
        }

        /* Particle Effects Container */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }

        /* Falling Stars */
        .falling-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            border-radius: 50%;
            animation: fallingStar 3s linear infinite;
            box-shadow: 0 0 4px #ffffff, 0 0 8px #64c8ff;
        }

        .falling-star::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 1px;
            background: linear-gradient(90deg, #ffffff, transparent);
            transform: rotate(-45deg);
            transform-origin: 0 0;
        }

        @keyframes fallingStar {
            0% {
                transform: translate(-10px, -10px);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translate(300px, 300px);
                opacity: 0;
            }
        }

        /* Satellites */
        .satellite {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #ff6b35;
            border-radius: 50%;
            animation: satellite 20s linear infinite;
            box-shadow: 0 0 6px #ff6b35;
        }

        .satellite::before {
            content: '';
            position: absolute;
            width: 1px;
            height: 8px;
            background: #ff6b35;
            top: -4px;
            left: 1px;
        }

        .satellite::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 1px;
            background: #ff6b35;
            top: 1px;
            left: -3px;
        }

        @keyframes satellite {
            0% {
                transform: translateX(-50px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 50px));
                opacity: 0;
            }
        }

        /* UFOs */
        .ufo {
            position: absolute;
            width: 12px;
            height: 6px;
            background: linear-gradient(ellipse, #00ff41, #32cd32);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: ufo 25s ease-in-out infinite;
            box-shadow: 
                0 0 10px #00ff41,
                0 0 20px rgba(0, 255, 65, 0.5);
        }

        .ufo::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 3px;
            background: linear-gradient(ellipse, rgba(0, 255, 65, 0.3), transparent);
            border-radius: 50%;
            top: 3px;
            left: -2px;
        }

        .ufo::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            border-radius: 50%;
            top: 1px;
            left: 2px;
            box-shadow: 4px 0 #ffffff, 8px 0 #ffffff;
        }

        @keyframes ufo {
            0% {
                transform: translate(-50px, 0px);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            25% {
                transform: translate(25vw, -20px);
            }
            50% {
                transform: translate(50vw, 10px);
            }
            75% {
                transform: translate(75vw, -10px);
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translate(calc(100vw + 50px), 5px);
                opacity: 0;
            }
        }

        /* Twinkling Stars Enhancement */
        .twinkle {
            position: absolute;
            width: 1px;
            height: 1px;
            background: #ffffff;
            border-radius: 50%;
            animation: twinkle 4s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* Flight Tracker Widget Styles */
        #flight-tracker-widget {
            min-height: 350px;
        }
        
        #satellite-tracker-widget {
            min-height: 350px;
        }
        
        #motion-sensor-widget {
            min-height: 350px;
        }
        
        .flight-tracker-content, .satellite-tracker-content, .motion-sensor-content {
            margin-bottom: 15px;
        }
        
        .flight-tracker-stats, .satellite-tracker-stats, .motion-sensor-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #17a2b8;
            font-size: 1.1em;
        }
        
        .flights-list, .satellites-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
        }
        
        .flight-loading, .satellite-loading, .motion-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .motion-data-display {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
        }
        
        .motion-data-item {
            background: rgba(255,20,147,0.15);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #ff1493;
            transition: background-color 0.3s ease;
        }
        
        .motion-data-item:hover {
            background: rgba(255,20,147,0.25);
        }
        
        .motion-data-item.status-motion {
            border-left-color: #ff4500;
        }
        
        .motion-data-item.status-stable {
            border-left-color: #32cd32;
        }
        
        .motion-data-item.calibrated {
            border-left-color: #1e90ff;
        }
        
        .motion-data-item.uncalibrated {
            border-left-color: #ffa500;
        }
        
        .adsb-flight-item {
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #17a2b8;
            transition: background-color 0.3s ease;
        }
        
        .adsb-flight-item:hover {
            background: rgba(255,255,255,0.12);
        }
        
        .adsb-flight-item.distance-close { 
            border-left-color: #dc3545; 
        }
        
        .adsb-flight-item.distance-medium { 
            border-left-color: #ffc107; 
        }
        
        .adsb-flight-item.distance-far { 
            border-left-color: #28a745; 
        }
        
        .satellite-item {
            background: rgba(255,165,0,0.15);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #ffa500;
            transition: background-color 0.3s ease;
        }
        
        .satellite-item:hover {
            background: rgba(255,165,0,0.25);
        }
        
        .satellite-item.category-space-station { 
            border-left-color: #ff4500; 
        }
        
        .satellite-item.category-communications { 
            border-left-color: #1e90ff; 
        }
        
        .satellite-item.category-earth-observation { 
            border-left-color: #32cd32; 
        }
        
        .satellite-item.category-navigation { 
            border-left-color: #ffd700; 
        }
        
        .satellite-item.category-weather { 
            border-left-color: #87ceeb; 
        }
        
        .satellite-item.category-science { 
            border-left-color: #da70d6; 
        }
        
        .flight-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-weight: bold;
        }
        
        .flight-callsign { 
            color: #17a2b8; 
            font-size: 0.95em;
        }
        
        .flight-distance { 
            color: #ffc107; 
            font-size: 0.9em;
        }
        
        .flight-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .flight-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
        }
        
        .detail-label { 
            color: #aaa; 
        }
        
        .detail-value { 
            color: #fff; 
            font-weight: bold; 
        }
        
        .flight-meta {
            font-size: 0.75em;
            color: #666;
            margin-top: 4px;
        }
        
        #adsb-connection-status.status-connected { 
            color: #28a745; 
        }
        
        #adsb-connection-status.status-disconnected { 
            color: #dc3545; 
        }
        
        .adsb-no-flights {
            text-align: center;
            padding: 15px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles-container"></div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🛸 UFO Tracker</h1>
            <p class="subtitle">Dual-Camera Detection System - Unified Dashboard</p>
            <div id="system-time"></div>
        </div>

        <!-- System Status Bar - Always Visible -->
        <div class="status-bar">
            <div class="status-grid-horizontal">
                <div class="status-item-compact" onclick="showCompassDetails()" style="cursor: pointer;" title="Click for compass details">
                    <span class="status-label">Compass:</span>
                    <span id="compass-status-bar">Loading...</span>
                    <span class="status-indicator-small" id="compass-indicator-bar"></span>
                </div>
                <div class="status-item-compact">
                    <span class="status-label">Storage:</span>
                    <span id="storage-status-bar">Loading...</span>
                    <span class="status-indicator-small" id="storage-indicator-bar"></span>
                </div>
                <div class="status-item-compact">
                    <span class="status-label">Music:</span>
                    <button class="btn-small" onclick="statusPlayMusic()" id="status-play-btn" title="Play Music">🎵</button>
                    <button class="btn-small" onclick="statusNextTrack()" id="status-next-btn" title="Next Track">⏭️</button>
                    <button class="btn-small" onclick="statusToggleShuffle()" id="status-shuffle-btn" title="Shuffle">🔀</button>
                    <button class="btn-small" onclick="statusStopMusic()" id="status-stop-btn" title="Stop Music">⏹️</button>
                </div>
                <div class="status-item-compact">
                    <button class="btn-small" onclick="refreshSystemStatus()">🔄</button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('cameras')">📹 Live Cameras</button>
            <button class="nav-tab" onclick="showSection('controls')">⚙️ Camera Controls</button>
            <button class="nav-tab" onclick="showSection('gallery')">🖼️ Gallery</button>
            <button class="nav-tab" onclick="showSection('settings')">🔧 System Settings</button>
        </div>

        <!-- Cameras Section -->
        <div id="cameras" class="content-section active">
            <div style="margin-bottom: 20px;">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="setViewMode('live')" id="live-mode-btn">📹 Live Streams</button>
                    <button class="btn btn-secondary" onclick="setViewMode('stacked')" id="stacked-mode-btn">📚 Image Stacking</button>
                    <button class="btn btn-warning disabled" title="Feature alignment disabled for compatibility" disabled>🎯 Feature Aligned</button>
                    <button class="btn btn-success" onclick="setViewMode('autotrack')" id="autotrack-mode-btn">🎯 Auto Tracking</button>
                    <button class="btn btn-info" onclick="showADSBView()" id="adsb-mode-btn">🛩️ Flight Tracker</button>
                </div>
                <div class="btn-group" style="margin-left: 20px;">
                    <!-- Camera streams now auto-load on page load -->
                </div>
            </div>
            
            <div class="camera-grid" id="camera-container">
                <!-- Live Mode - Always MJPEG for motion -->
                <div id="live-cameras">
                    <!-- IR Camera -->
                    <div class="camera-panel">
                        <h3>📡 IR Camera (Live Stream)</h3>
                        <div class="camera-preview">
                            <img id="ir-live" data-src="http://10.0.1.164:5001/ir_feed" alt="IR Camera Live" onclick="toggleFullscreen('ir')" style="cursor: pointer;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjI0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmdHcmFkMzIwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwMTEyMiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzAwMDgxNCIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTAwMzMiIHN0b3Atb3BhY2l0eT0iMSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9InRleHRHcmFkMzIwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzY0YzhmZiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxmaWx0ZXIgaWQ9Imdsb3czMjAiPgogICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIzIiByZXN1bHQ9ImNvbG9yZWRCbHVyIi8+CiAgICAgIDxmZU1lcmdlPiAKICAgICAgICA8ZmVNZXJnZU5vZGUgaW49ImNvbG9yZWRCbHVyIi8+CiAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJTb3VyY2VHcmFwaGljIi8+CiAgICAgIDwvZmVNZXJnZT4KICAgIDwvZmlsdGVyPgogICAgPGZpbHRlciBpZD0ic2NhbjMyMCI+CiAgICAgIDxmZVR1cmJ1bGVuY2UgYmFzZUZyZXF1ZW5jeT0iMC45IiBudW1PY3RhdmVzPSI0IiByZXN1bHQ9Im5vaXNlIi8+CiAgICAgIDxmZUNvbG9yTWF0cml4IGluPSJub2lzZSIgdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPgogICAgICA8ZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgICAgICA8ZmVGdW5jQSB0eXBlPSJkaXNjcmV0ZSIgdGFibGVWYWx1ZXM9IjAuNSAwLjIgMC44IDAuMyAwLjEgMC43Ii8+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogIDwvZGVmcz4KICA8IS0tIEJhY2tncm91bmQgLS0+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjYmdHcmFkMzIwKSIvPgogIDwhLS0gR3JpZCBwYXR0ZXJuIC0tPgogIDxwYXR0ZXJuIGlkPSJncmlkMzIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPgogICAgPHBhdGggZD0iTSA0MCAwIEwgMCAwIDAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwZmZmZiIgc3Ryb2tlLXdpZHRoPSIwLjUiIG9wYWNpdHk9IjAuMTUiLz4KICA8L3BhdHRlcm4+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjZ3JpZDMyMCkiLz4KICA8IS0tIFNjYW4gbGluZXMgLS0+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjc2NhbjMyMCkiIG9wYWNpdHk9IjAuMSIvPgogIDwhLS0gQm9yZGVyIC0tPgogIDxyZWN0IHg9IjIiIHk9IjIiIHdpZHRoPSIzMTYiIGhlaWdodD0iMjM2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmZmYiIHN0cm9rZS13aWR0aD0iMiIgb3BhY2l0eT0iMC42Ii8+CiAgPCEtLSBDb3JuZXIgYWNjZW50cyAtLT4KICA8cGF0aCBkPSJNIDEwIDEwIEwgMzAgMTAgTCAzMCAzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDxwYXRoIGQ9Ik0gMzEwIDEwIEwgMjkwIDEwIEwgMjkwIDMwIiBmaWxsPSJub25lIiBzdHJva2U9IiM2NGM4ZmYiIHN0cm9rZS13aWR0aD0iMyIgb3BhY2l0eT0iMC44Ii8+CiAgPHBhdGggZD0iTSAxMCAyMzAgTCAzMCAyMzAgTCAzMCAyMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8cGF0aCBkPSJNIDMxMCAyMzAgTCAyOTAgMjMwIEwgMjkwIDIxMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDwhLS0gSWNvbiAtLT4KICA8dGV4dCB4PSIxNjAiIHk9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIzMCIgZmlsbD0idXJsKCN0ZXh0R3JhZDMyMCkiIGZpbHRlcj0idXJsKCNnbG93MzIwKSI+8J+ToTwvdGV4dD4KICA8IS0tIE1haW4gdGV4dCAtLT4KICA8dGV4dCB4PSIxNjAiIHk9IjEzMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IidDb3VyaWVyIE5ldycsIG1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9InVybCgjdGV4dEdyYWQzMjApIiBmaWx0ZXI9InVybCgjZ2xvdzMyMCkiPklSIENBTUVSQSBMT0FESU5HLi4uPC90ZXh0PgogIDwhLS0gU3RhdHVzIGluZGljYXRvciAtLT4KICA8Y2lyY2xlIGN4PSIyOTAiIGN5PSIzMCIgcj0iNCIgZmlsbD0iIzAwZmYwMCIgb3BhY2l0eT0iMC44Ij4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIHZhbHVlcz0iMC44OzAuMzswLjgiIGR1cj0iMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CiAgPC9jaXJjbGU+CiAgPCEtLSBMb2FkaW5nIGFuaW1hdGlvbiAtLT4KICA8cmVjdCB4PSIxMTAiIHk9IjE0NSIgd2lkdGg9IjEwMCIgaGVpZ2h0PSI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmZmYiIHN0cm9rZS13aWR0aD0iMiIgb3BhY2l0eT0iMC41Ii8+CiAgPHJlY3QgeD0iMTEwIiB5PSIxNDUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0IiBmaWxsPSIjNjRjOGZmIj4KICAgIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0idHJhbnNsYXRlIiB2YWx1ZXM9IjAsMDsgODAsMDsgMCwwIiBkdXI9IjNzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogIDwvcmVjdD4KPC9zdmc+">
                            <div class="camera-overlay">IR Live</div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="refreshStream('ir')">🔄 Refresh Stream</button>
                            <button class="btn btn-warning" onclick="captureFrame('ir')">📸 Capture</button>
                            <button class="btn btn-secondary" id="wasd-toggle-btn-live" onclick="toggleWASDControl()" title="Enable WASD keyboard control">⌨️ WASD: OFF</button>
                        </div>
                    </div>

                    <!-- HQ Camera -->
                    <div class="camera-panel">
                        <h3>📷 HQ Camera (Live Stream)</h3>
                        <div class="camera-preview">
                            <img id="hq-live" data-src="http://10.0.1.164:5001/hq_feed" alt="HQ Camera Live" onclick="toggleFullscreen('hq')" style="cursor: pointer;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjI0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmdHcmFkMzIwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwMTEyMiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzAwMDgxNCIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTAwMzMiIHN0b3Atb3BhY2l0eT0iMSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9InRleHRHcmFkMzIwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzY0YzhmZiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxmaWx0ZXIgaWQ9Imdsb3czMjAiPgogICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIzIiByZXN1bHQ9ImNvbG9yZWRCbHVyIi8+CiAgICAgIDxmZU1lcmdlPiAKICAgICAgICA8ZmVNZXJnZU5vZGUgaW49ImNvbG9yZWRCbHVyIi8+CiAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJTb3VyY2VHcmFwaGljIi8+CiAgICAgIDwvZmVNZXJnZT4KICAgIDwvZmlsdGVyPgogICAgPGZpbHRlciBpZD0ic2NhbjMyMCI+CiAgICAgIDxmZVR1cmJ1bGVuY2UgYmFzZUZyZXF1ZW5jeT0iMC45IiBudW1PY3RhdmVzPSI0IiByZXN1bHQ9Im5vaXNlIi8+CiAgICAgIDxmZUNvbG9yTWF0cml4IGluPSJub2lzZSIgdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPgogICAgICA8ZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgICAgICA8ZmVGdW5jQSB0eXBlPSJkaXNjcmV0ZSIgdGFibGVWYWx1ZXM9IjAuNSAwLjIgMC44IDAuMyAwLjEgMC43Ii8+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogIDwvZGVmcz4KICA8IS0tIEJhY2tncm91bmQgLS0+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjYmdHcmFkMzIwKSIvPgogIDwhLS0gR3JpZCBwYXR0ZXJuIC0tPgogIDxwYXR0ZXJuIGlkPSJncmlkMzIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPgogICAgPHBhdGggZD0iTSA0MCAwIEwgMCAwIDAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwZmZmZiIgc3Ryb2tlLXdpZHRoPSIwLjUiIG9wYWNpdHk9IjAuMTUiLz4KICA8L3BhdHRlcm4+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjZ3JpZDMyMCkiLz4KICA8IS0tIFNjYW4gbGluZXMgLS0+CiAgPHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIyNDAiIGZpbGw9InVybCgjc2NhbjMyMCkiIG9wYWNpdHk9IjAuMSIvPgogIDwhLS0gQm9yZGVyIC0tPgogIDxyZWN0IHg9IjIiIHk9IjIiIHdpZHRoPSIzMTYiIGhlaWdodD0iMjM2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmZmYiIHN0cm9rZS13aWR0aD0iMiIgb3BhY2l0eT0iMC42Ii8+CiAgPCEtLSBDb3JuZXIgYWNjZW50cyAtLT4KICA8cGF0aCBkPSJNIDEwIDEwIEwgMzAgMTAgTCAzMCAzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDxwYXRoIGQ9Ik0gMzEwIDEwIEwgMjkwIDEwIEwgMjkwIDMwIiBmaWxsPSJub25lIiBzdHJva2U9IiM2NGM4ZmYiIHN0cm9rZS13aWR0aD0iMyIgb3BhY2l0eT0iMC44Ii8+CiAgPHBhdGggZD0iTSAxMCAyMzAgTCAzMCAyMzAgTCAzMCAyMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8cGF0aCBkPSJNIDMxMCAyMzAgTCAyOTAgMjMwIEwgMjkwIDIxMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDwhLS0gSWNvbiAtLT4KICA8dGV4dCB4PSIxNjAiIHk9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIzMCIgZmlsbD0idXJsKCN0ZXh0R3JhZDMyMCkiIGZpbHRlcj0idXJsKCNnbG93MzIwKSI+8J+TtzwvdGV4dD4KICA8IS0tIE1haW4gdGV4dCAtLT4KICA8dGV4dCB4PSIxNjAiIHk9IjEzMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IidDb3VyaWVyIE5ldycsIG1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9InVybCgjdGV4dEdyYWQzMjApIiBmaWx0ZXI9InVybCgjZ2xvdzMyMCkiPkhRIENBTUVSQSBMT0FESU5HLi4uPC90ZXh0PgogIDwhLS0gU3RhdHVzIGluZGljYXRvciAtLT4KICA8Y2lyY2xlIGN4PSIyOTAiIGN5PSIzMCIgcj0iNCIgZmlsbD0iIzAwZmYwMCIgb3BhY2l0eT0iMC44Ij4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIHZhbHVlcz0iMC44OzAuMzswLjgiIGR1cj0iMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CiAgPC9jaXJjbGU+CiAgPCEtLSBMb2FkaW5nIGFuaW1hdGlvbiAtLT4KICA8cmVjdCB4PSIxMTAiIHk9IjE0NSIgd2lkdGg9IjEwMCIgaGVpZ2h0PSI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmZmYiIHN0cm9rZS13aWR0aD0iMiIgb3BhY2l0eT0iMC41Ii8+CiAgPHJlY3QgeD0iMTEwIiB5PSIxNDUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0IiBmaWxsPSIjNjRjOGZmIj4KICAgIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0idHJhbnNsYXRlIiB2YWx1ZXM9IjAsMDsgODAsMDsgMCwwIiBkdXI9IjNzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogIDwvcmVjdD4KPC9zdmc+">
                            <div class="camera-overlay">HQ Live</div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="refreshStream('hq')">🔄 Refresh Stream</button>
                            <button class="btn btn-warning" onclick="captureFrame('hq')">📸 Capture</button>
                        </div>
                    </div>
                    
                    <!-- ADSB Flight Tracker Widget -->
                    <div class="camera-panel" id="flight-tracker-widget">
                        <h3>🛩️ Flight Tracker <span id="adsb-connection-status" class="status-indicator">Connecting...</span></h3>
                        <div class="flight-tracker-content">
                            <div class="flight-tracker-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Flights:</span>
                                    <span id="adsb-flight-count" class="stat-value">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Range:</span>
                                    <span class="stat-value" id="adsb-range">10mi</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Updated:</span>
                                    <span id="adsb-last-update" class="stat-value">Never</span>
                                </div>
                            </div>
                            <div id="adsb-flights-list" class="flights-list">
                                <div class="flight-loading">
                                    <p>📡 Initializing flight tracker...</p>
                                    <small>Connecting to PiAware SkyAware</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="refreshADSBData()">🔄 Refresh</button>
                            <button class="btn btn-secondary btn-sm" onclick="showADSBDetails()">📊 Details</button>
                            <button class="btn btn-info btn-sm" onclick="toggleADSBTracking()" id="adsb-toggle-btn">⏹️ Stop ADSB</button>
                        </div>
                    </div>
                    
                    <!-- Satellite Tracker Widget -->
                    <div class="camera-panel" id="satellite-tracker-widget">
                        <h3>🛰️ Satellite Tracker <span id="satellite-connection-status" class="status-indicator">Connecting...</span></h3>
                        <div class="satellite-tracker-content">
                            <div class="satellite-tracker-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Satellites:</span>
                                    <span id="satellite-count" class="stat-value">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Min Elev:</span>
                                    <span class="stat-value" id="satellite-min-elevation">10°</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Updated:</span>
                                    <span id="satellite-last-update" class="stat-value">Never</span>
                                </div>
                            </div>
                            <div id="satellite-list" class="satellites-list">
                                <div class="satellite-loading">
                                    <p>🛰️ Initializing satellite tracker...</p>
                                    <small>Loading TLE data from CelesTrak</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="refreshSatelliteData()">🔄 Refresh</button>
                            <button class="btn btn-secondary btn-sm" onclick="showSatelliteDetails()">📊 Details</button>
                            <button class="btn btn-info btn-sm" onclick="toggleSatelliteTracking()" id="satellite-toggle-btn">⏹️ Stop Tracking</button>
                        </div>
                    </div>
                    
                    <!-- Motion Sensor Widget -->
                    <div class="camera-panel" id="motion-sensor-widget">
                        <h3>📱 Motion Sensor <span id="motion-connection-status" class="status-indicator">Connecting...</span></h3>
                        <div class="motion-sensor-content">
                            <div class="motion-sensor-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Status:</span>
                                    <span id="motion-status" class="stat-value">Unknown</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Stability:</span>
                                    <span id="motion-stability" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Temperature:</span>
                                    <span id="motion-temperature" class="stat-value">0°C</span>
                                </div>
                            </div>
                            <div id="motion-data-display" class="motion-data-display">
                                <div class="motion-loading">
                                    <p>📱 Initializing motion sensor...</p>
                                    <small>Connecting to MPU-6050 via I2C</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="refreshMotionData()">🔄 Refresh</button>
                            <button class="btn btn-warning btn-sm" onclick="calibrateMotionSensor()">⚙️ Calibrate</button>
                            <button class="btn btn-secondary btn-sm" onclick="showMotionDetails()">📊 Details</button>
                        </div>
                    </div>
                </div>
                
                <!-- Auto Tracking Mode -->
                <div id="autotrack-cameras" style="display: none;">
                    <div class="tracking-status-panel">
                        <h3>🎯 Auto Tracking System</h3>
                        <p class="text-muted" style="margin-bottom: 15px; font-size: 0.9em;">
                            Client-side visual tracking with optional motor control for physical pan/tilt movement.
                        </p>
                        <div class="tracking-controls">
                            <div class="btn-group">
                                <button class="btn btn-success" id="enable-tracking-btn" onclick="toggleClientAutoTracking()">Enable Tracking</button>
                                <button class="btn btn-primary" id="save-image-btn" onclick="saveCurrentImage()">💾 Save Image</button>
                                <button class="btn btn-info" id="download-image-btn" onclick="downloadCurrentImage()">⬇️ Download</button>
                                <button class="btn btn-warning" id="record-btn" onclick="toggleRecording()">🔴 Record</button>
                                <button class="btn btn-secondary" id="auto-record-btn" onclick="toggleAutoRecord()">📹 Auto-Record</button>
                            </div>
                        </div>
                        
                        <!-- Motor Control Section -->
                        <div class="motor-controls" style="margin-top: 20px; padding: 15px; background: rgba(255, 165, 0, 0.1); border-radius: 8px; border-left: 4px solid #ff9800;">
                            <h4>🎯 Physical Motor Tracking</h4>
                            <p class="text-muted" style="margin-bottom: 15px; font-size: 0.9em;">
                                Enable stepper motors to physically move the camera mount based on detected motion.
                            </p>
                            
                            <div class="btn-group" style="margin-bottom: 15px;">
                                <button class="btn btn-success" id="motor-tracking-btn" onclick="toggleMotorTracking()" title="Toggle motor tracking on/off">🚀 Start Motor Tracking</button>
                                <button class="btn btn-info" onclick="calibrateAutoTracking()" title="Calibrate motor positions">🔧 Calibrate Motors</button>
                                <button class="btn btn-secondary" onclick="updateAutoTrackingStatus()" title="Refresh auto-tracking status">🔄 Refresh Status</button>
                                <button class="btn btn-secondary" id="wasd-toggle-btn" onclick="toggleWASDControl()" title="Enable WASD keyboard control">⌨️ WASD: OFF</button>
                            </div>
                            
                            <div class="status-grid" style="max-width: 600px;">
                                <div class="status-item">
                                    <span class="status-label">Motor Status:</span>
                                    <span id="auto-tracking-status" class="status-value">Unknown</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tracking-status">
                            <div class="status-grid">
                                <div class="status-item">
                                    <span class="status-label">Tracking:</span>
                                    <span id="tracking-enabled-status" class="status-value">Disabled</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Motion Detected:</span>
                                    <span id="motion-detected-status" class="status-value">None</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Sensitivity:</span>
                                    <span id="sensitivity-value" class="status-value">Medium</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Objects Tracked:</span>
                                    <span id="objects-tracked-count" class="status-value">0</span>
                                </div>
                            </div>
                            <div class="sensitivity-controls" style="margin-top: 10px;">
                                <label for="motion-sensitivity">Motion Sensitivity:</label>
                                <input type="range" id="motion-sensitivity" min="10" max="100" value="40" onchange="updateSensitivity()">
                                <span id="sensitivity-display">40</span>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="camera-grid" style="position: relative;">
                        <!-- IR Camera with Motion Detection -->
                        <div class="camera-panel">
                            <h3>📡 IR Camera (Motion Detection)</h3>
                            <div class="camera-preview" style="position: relative;">
                                <img id="ir-motion-feed" alt="IR Motion Feed" 
                                     data-src="http://10.0.1.164:5001/ir_feed" 
                                     crossorigin="anonymous"
                                     style="width: 640px; height: 480px; border: 2px solid #333; background: #000;"
                                     onclick="toggleFullscreen('ir-motion-feed')" />
                                <canvas id="ir-motion-canvas" width="640" height="480" style="display: none;"></canvas>
                                <canvas id="ir-overlay-canvas" width="640" height="480" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                                <!-- IR Zoom Window -->
                                <div id="ir-crop-window" style="position: absolute; border: 3px solid #00ff00; background: rgba(0,0,0,0.8); display: none; z-index: 10;">
                                    <canvas id="ir-crop-canvas" width="200" height="200" style="display: block;"></canvas>
                                    <canvas id="ir-crop-overlay" width="200" height="200" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                                    <div style="color: #00ff00; text-align: center; padding: 2px; font-size: 12px;">IR Motion Zoom</div>
                                </div>
                                <div class="camera-overlay">IR Detection</div>
                            </div>
                            <div class="tracking-info">
                                <div class="info-item">
                                    <span class="info-label">Motion Objects:</span>
                                    <span id="motion-objects-count" class="info-value">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Processing FPS:</span>
                                    <span id="ir-processing-fps" class="info-value">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HQ Camera with Smart Crop Overlay -->
                        <div class="camera-panel">
                            <h3>📷 HQ Camera (Annotated & Cropped)</h3>
                            <div class="camera-preview" style="position: relative;">
                                <img id="hq-motion-feed" alt="HQ Motion Feed" 
                                     data-src="http://10.0.1.164:5001/hq_feed" 
                                     crossorigin="anonymous"
                                     style="width: 640px; height: 480px; border: 2px solid #333; background: #000;"
                                     onclick="toggleFullscreen('hq-motion-feed')" />
                                <canvas id="hq-main-canvas" width="640" height="480" style="display: none;"></canvas>
                                <canvas id="hq-annotation-canvas" width="640" height="480" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                                <!-- Smart Crop Window -->
                                <div id="hq-crop-window" style="position: absolute; border: 3px solid #00ff00; background: rgba(0,0,0,0.8); display: none; z-index: 10;">
                                    <canvas id="hq-crop-canvas" width="200" height="200" style="display: block;"></canvas>
                                    <div style="color: #00ff00; text-align: center; padding: 2px; font-size: 12px;">Motion Zoom</div>
                                </div>
                                <div class="camera-overlay">HQ Annotated</div>
                            </div>
                            <div class="tracking-info">
                                <div class="info-item">
                                    <span class="info-label">Crop Active:</span>
                                    <span id="crop-active-status" class="info-value">No</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Annotations:</span>
                                    <span id="annotations-count" class="info-value">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Zoom Controls -->
                    <div class="tracking-settings-panel">
                        <h4>🔍 Manual Zoom Controls</h4>
                        <div class="settings-grid">
                            <div class="setting-group">
                                <label for="zoom-level">Zoom Level:</label>
                                <input type="range" id="zoom-level" class="control-input" 
                                       min="1" max="5" step="0.5" value="1"
                                       oninput="updateZoomDisplay(); applyZoom(this.value)">
                                <div class="range-display">
                                    <span>1x</span>
                                    <span id="zoom-value">1.0x</span>
                                    <span>5x</span>
                                </div>
                            </div>
                            <div class="setting-group">
                                <button class="btn btn-info" onclick="zoomToCenter()" style="margin-right: 10px;">🎯 Center Zoom</button>
                                <button class="btn btn-warning" onclick="resetZoom()">↩️ Reset View</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tracking Settings Panel -->
                    <div class="tracking-settings-panel">
                        <h4>⚙️ Tracking Settings</h4>
                        <div class="settings-grid">
                            <div class="setting-group">
                                <label for="target-selection-mode">Target Selection:</label>
                                <select id="target-selection-mode" class="control-input" onchange="updateTrackingSettings()">
                                    <option value="largest">Largest Object</option>
                                    <option value="newest">Newest Detection</option>
                                    <option value="most_active">Most Active</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="tracking-timeout">Tracking Timeout (seconds):</label>
                                <input type="range" id="tracking-timeout" class="control-input" 
                                       min="1" max="30" step="1" value="5"
                                       oninput="updateTrackingTimeoutDisplay(); updateTrackingSettings()">
                                <div class="range-display">
                                    <span>1s</span>
                                    <span id="tracking-timeout-value">5s</span>
                                    <span>30s</span>
                                </div>
                            </div>
                            <div class="setting-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="auto-calibration" onchange="updateTrackingSettings()" checked>
                                    <label for="auto-calibration">Auto Calibration</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Motion Detection Panel -->
                    <div class="tracking-settings-panel">
                        <h4>🎯 Motion Detection & Auto-Capture</h4>
                        <div class="feature-tracking-description">
                            Advanced client-side motion detection with automatic snapshot capture and annotations.
                        </div>
                        
                        <!-- Motion Detection Status -->
                        <div class="detection-info" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0;">
                            <div class="detection-stat">
                                <div class="value" id="motion-objects-detected">0</div>
                                <div class="label">Objects Detected</div>
                            </div>
                            <div class="detection-stat">
                                <div class="value" id="motion-sensitivity-level">Medium</div>
                                <div class="label">Sensitivity Level</div>
                            </div>
                            <div class="detection-stat">
                                <div class="value" id="motion-processing-fps">0</div>
                                <div class="label">Processing FPS</div>
                            </div>
                            <div class="detection-stat">
                                <div class="value" id="motion-snapshots-count">0</div>
                                <div class="label">Snapshots Captured</div>
                            </div>
                        </div>
                        
                        <!-- Motion Detection Controls -->
                        <div class="control-group">
                            <div class="btn-group">
                                <button class="btn btn-success" id="motion-enable-btn" onclick="toggleMotionDetection()">🎯 Enable Detection</button>
                                <button class="btn btn-primary" onclick="captureMotionSnapshot()">📷 Capture Snapshot</button>
                                <button class="btn btn-info" onclick="testMotionDetection()">🧪 Test Detection</button>
                                <button class="btn btn-warning" onclick="clearMotionOverlays()">🧹 Clear Overlays</button>
                            </div>
                        </div>
                        
                        <!-- Motion Settings -->
                        <div class="settings-grid">
                            <div class="setting-group">
                                <label for="motion-sensitivity-slider">Sensitivity:</label>
                                <input type="range" id="motion-sensitivity-slider" min="10" max="100" value="40" 
                                       oninput="updateMotionSensitivity()" class="control-input">
                                <div class="range-display">
                                    <span>10</span>
                                    <span id="motion-sensitivity-display">40</span>
                                    <span>100</span>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label for="motion-capture-threshold">Auto-Capture Threshold:</label>
                                <input type="number" id="motion-capture-threshold" min="1" max="10" value="2" 
                                       onchange="updateMotionCaptureThreshold()" class="control-input">
                                <small class="text-muted">Objects needed to trigger capture</small>
                            </div>
                            <div class="setting-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="motion-auto-capture" checked onchange="toggleMotionAutoCapture()">
                                    <label for="motion-auto-capture">Auto-Capture Enabled</label>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label for="motion-capture-camera">Capture Camera:</label>
                                <select id="motion-capture-camera" class="control-input">
                                    <option value="hq">HQ Camera</option>
                                    <option value="ir">IR Camera</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Point-and-Click Feature Tracking Panel -->
                    <div class="tracking-settings-panel">
                        <h4>🎯 Point & Click Feature Tracking</h4>
                        <div class="feature-tracking-description">
                            Select any feature on a still frame and track it with motors. Runs in background while you navigate.
                        </div>
                        
                        <!-- Feature Tracking Container -->
                        <div id="feature-tracking-container">
                            <!-- Camera Selection -->
                            <div class="control-group">
                                <label>Camera Source:</label>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-info feature-camera-btn active" 
                                            data-camera="ir" onclick="featureTracking.currentCamera = 'ir'; updateFeatureTrackingUI()">
                                        📡 IR Camera
                                    </button>
                                    <button class="btn btn-sm btn-outline-info feature-camera-btn" 
                                            data-camera="hq" onclick="featureTracking.currentCamera = 'hq'; updateFeatureTrackingUI()">
                                        📷 HQ Camera
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Load Frame Button -->
                            <div class="control-group">
                                <button class="btn btn-primary" id="load-feature-frame-btn" 
                                        onclick="loadFeatureTrackingFrame(featureTracking.currentCamera)">
                                    📸 Load Still Frame
                                </button>
                                <div class="feature-status" id="feature-select-status">⭕ No Feature Selected</div>
                            </div>
                            
                            <!-- Canvas for Frame Display -->
                            <div class="feature-frame-container">
                                <canvas id="feature-tracking-canvas" class="feature-tracking-canvas"></canvas>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="feature-instructions" id="feature-tracking-instructions">
                                <p>📷 <strong>Step 1:</strong> Load a still frame from IR or HQ camera</p>
                                <p>🎯 <strong>Step 2:</strong> Click on a feature in the image to select it</p>
                                <p>🚀 <strong>Step 3:</strong> Start tracking to follow the feature with motors</p>
                            </div>
                            
                            <!-- Control Buttons -->
                            <div class="control-group">
                                <button class="btn btn-success" id="start-feature-tracking-btn" 
                                        onclick="toggleFeatureTracking()" disabled>
                                    ▶️ Start Tracking
                                </button>
                                <button class="btn btn-danger" id="stop-feature-tracking-btn" 
                                        onclick="stopFeatureTracking()" disabled style="display: none;">
                                    ⏹️ Stop Tracking
                                </button>
                                <button class="btn btn-warning" id="clear-feature-selection-btn" 
                                        onclick="clearFeatureSelection()" disabled>
                                    🗑️ Clear Selection
                                </button>
                                <button class="btn btn-info" onclick="updateFeatureTrackingStatus()">
                                    🔄 Refresh Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Stacked Mode -->
                <div id="stacked-cameras" style="display: none;">
                    <div class="camera-grid" style="grid-template-columns: 1fr;">
                        <!-- IR Camera Stacking -->
                        <div class="camera-panel">
                            <h3>📚 IR Camera Stacking <span class="live-indicator">● LIVE</span></h3>
                            <div class="camera-preview">
                                <img id="stacked-ir-preview" alt="Stacked IR Image" 
                                     src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZDEyODAiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMDAxMTIyIiBzdG9wLW9wYWNpdHk9IjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iNTAlIiBzdG9wLWNvbG9yPSIjMDAwODE0IiBzdG9wLW9wYWNpdHk9IjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzFhMDAzMyIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0idGV4dEdyYWQxMjgwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzY0YzhmZiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxmaWx0ZXIgaWQ9Imdsb3cxMjgwIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMyIgcmVzdWx0PSJjb2xvcmVkQmx1ciIvPgogICAgICA8ZmVNZXJnZT4gCiAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJjb2xvcmVkQmx1ciIvPgogICAgICAgIDxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIvPgogICAgICA8L2ZlTWVyZ2U+CiAgICA8L2ZpbHRlcj4KICAgIDxmaWx0ZXIgaWQ9InNjYW4xMjgwIj4KICAgICAgPGZlVHVyYnVsZW5jZSBiYXNlRnJlcXVlbmN5PSIwLjkiIG51bU9jdGF2ZXM9IjQiIHJlc3VsdD0ibm9pc2UiLz4KICAgICAgPGZlQ29sb3JNYXRyaXggaW49Im5vaXNlIiB0eXBlPSJzYXR1cmF0ZSIgdmFsdWVzPSIwIi8+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMC41IDAuMiAwLjggMC4zIDAuMSAwLjciLz4KICAgICAgPC9mZUNvbXBvbmVudFRyYW5zZmVyPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIAogIDwhLS0gQmFja2dyb3VuZCAtLT4KICA8cmVjdCB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIGZpbGw9InVybCgjYmdHcmFkMTI4MCkiLz4KICA8IS0tIEdyaWQgcGF0dGVybiAtLT4KICA8cGF0dGVybiBpZD0iZ3JpZDEyODAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CiAgICA8cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjAuNSIgb3BhY2l0eT0iMC4xNSIvPgogIDwvcGF0dGVybj4KICA8cmVjdCB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIGZpbGw9InVybCgjZ3JpZDEyODApIi8+CiAgPCEtLSBTY2FuIGxpbmVzIC0tPgogIDxyZWN0IHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjcyMCIgZmlsbD0idXJsKCNzY2FuMTI4MCkiIG9wYWNpdHk9IjAuMSIvPgogIDwhLS0gQm9yZGVyIC0tPgogIDxyZWN0IHg9IjIiIHk9IjIiIHdpZHRoPSIxMjc2IiBoZWlnaHQ9IjcxNiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNiIvPgogIDwhLS0gQ29ybmVyIGFjY2VudHMgLS0+CiAgPHBhdGggZD0iTSAxMCAxMCBMIDMwIDEwIEwgMzAgMzAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8cGF0aCBkPSJNIDEyNzAgMTAgTCAxMjUwIDEwIEwgMTI1MCAzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDxwYXRoIGQ9Ik0gMTAgNzEwIEwgMzAgNzEwIEwgMzAgNjkwIiBmaWxsPSJub25lIiBzdHJva2U9IiM2NGM4ZmYiIHN0cm9rZS13aWR0aD0iMyIgb3BhY2l0eT0iMC44Ii8+CiAgPHBhdGggZD0iTSAxMjcwIDcxMCBMIDEyNTAgNzEwIEwgMTI1MCA2OTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8IS0tIEljb24gLS0+CiAgPHRleHQgeD0iNjQwIiB5PSIzNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iOTAiIGZpbGw9InVybCgjdGV4dEdyYWQxMjgwKSIgZmlsdGVyPSJ1cmwoI2dsb3cxMjgwKSI+8J+TmjwvdGV4dD4KICA8IS0tIE1haW4gdGV4dCAtLT4KICA8dGV4dCB4PSI2NDAiIHk9IjM3MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IidDb3VyaWVyIE5ldycsIG1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9InVybCgjdGV4dEdyYWQxMjgwKSIgZmlsdGVyPSJ1cmwoI2dsb3cxMjgwKSI+U1RBQ0tJTkcgSVIgRlJBTUVTLi4uPC90ZXh0PgogIDwhLS0gU3RhdHVzIGluZGljYXRvciAtLT4KICA8Y2lyY2xlIGN4PSIxMjUwIiBjeT0iMzAiIHI9IjQiIGZpbGw9IiMwMGZmMDAiIG9wYWNpdHk9IjAuOCI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiB2YWx1ZXM9IjAuODswLjM7MC44IiBkdXI9IjJzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogIDwvY2lyY2xlPgogIDwhLS0gTG9hZGluZyBhbmltYXRpb24gLS0+CiAgPHJlY3QgeD0iNTkwIiB5PSIzODUiIHdpZHRoPSIxMDAiIGhlaWdodD0iNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNSIvPgogIDxyZWN0IHg9IjU5MCIgeT0iMzg1IiB3aWR0aD0iMjAiIGhlaWdodD0iNCIgZmlsbD0iIzY0YzhmZiI+CiAgICA8YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InRyYW5zbGF0ZSIgdmFsdWVzPSIwLDA7IDgwLDA7IDAsMCIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICA8L3JlY3Q+Cjwvc3ZnPg=="
                                     onclick="toggleStackedFullscreen('ir')" style="cursor: pointer;">
                                <div class="camera-overlay">Stacked IR</div>
                            </div>
                            <div class="control-group">
                                <label for="ir-stack-count">Stack Count</label>
                                <input type="range" id="ir-stack-count" class="control-input" 
                                       min="2" max="1000" step="1" value="5"
                                       oninput="updateStackCount('ir')">
                                <div class="range-display">
                                    <span>2</span>
                                    <span id="ir-stack-count-value">5</span>
                                    <span>1000</span>
                                </div>
                            </div>
                            <div class="control-group">
                                <small class="text-muted">📊 Default: Average stacking blends all frames equally</small>
                            </div>
                            <div class="control-group">
                                <label title="Keeps the brightest pixel from each frame - simulates long exposure photography. Good for capturing motion trails and star trails.">
                                    <input type="checkbox" id="ir-long-exposure" onchange="toggleLongExposure('ir')">
                                    🌌 Long Exposure Mode
                                </label>
                            </div>
                            <div class="control-group">
                                <label title="Adds brightness from each frame together (30% per frame) - creates artistic light painting effects. Use with fewer frames (3-5) to avoid overexposure.">
                                    <input type="checkbox" id="ir-juiced-exposure" onchange="toggleJuicedExposure('ir')">
                                    🔥 Juiced Exposure Mode
                                </label>
                            </div>
                            <div class="control-group">
                                <label title="Ignore frame count limit - disable stack count and use all available frames">
                                    <input type="checkbox" id="ir-ignore-count" onchange="toggleIgnoreCount('ir')">
                                    🔓 Ignore Count Limit
                                </label>
                            </div>
                            <div class="btn-group">
                                <!-- Client-side stacking controls -->
                                <button class="btn btn-success" onclick="saveStackedImage('ir')">💾 Save Stack</button>
                                <button class="btn btn-warning" onclick="clearStackingBuffer('ir')">🗑️ Clear Buffer</button>
                                <button class="btn btn-info" onclick="updateStackedImage('ir')">🔄 Stack Now</button>
                            </div>
                        </div>

                        <!-- HQ Camera Stacking -->
                        <div class="camera-panel">
                            <h3>📚 HQ Camera Stacking <span class="live-indicator">● LIVE</span></h3>
                            <div class="camera-preview">
                                <img id="stacked-hq-preview" alt="Stacked HQ Image"
                                     src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZDEyODAiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMDAxMTIyIiBzdG9wLW9wYWNpdHk9IjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iNTAlIiBzdG9wLWNvbG9yPSIjMDAwODE0IiBzdG9wLW9wYWNpdHk9IjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzFhMDAzMyIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0idGV4dEdyYWQxMjgwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iIzY0YzhmZiIgc3RvcC1vcGFjaXR5PSIxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmZmYiIHN0b3Atb3BhY2l0eT0iMC44IiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxmaWx0ZXIgaWQ9Imdsb3cxMjgwIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMyIgcmVzdWx0PSJjb2xvcmVkQmx1ciIvPgogICAgICA8ZmVNZXJnZT4gCiAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJjb2xvcmVkQmx1ciIvPgogICAgICAgIDxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIvPgogICAgICA8L2ZlTWVyZ2U+CiAgICA8L2ZpbHRlcj4KICAgIDxmaWx0ZXIgaWQ9InNjYW4xMjgwIj4KICAgICAgPGZlVHVyYnVsZW5jZSBiYXNlRnJlcXVlbmN5PSIwLjkiIG51bU9jdGF2ZXM9IjQiIHJlc3VsdD0ibm9pc2UiLz4KICAgICAgPGZlQ29sb3JNYXRyaXggaW49Im5vaXNlIiB0eXBlPSJzYXR1cmF0ZSIgdmFsdWVzPSIwIi8+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMC41IDAuMiAwLjggMC4zIDAuMSAwLjciLz4KICAgICAgPC9mZUNvbXBvbmVudFRyYW5zZmVyPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIAogIDwhLS0gQmFja2dyb3VuZCAtLT4KICA8cmVjdCB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIGZpbGw9InVybCgjYmdHcmFkMTI4MCkiLz4KICA8IS0tIEdyaWQgcGF0dGVybiAtLT4KICA8cGF0dGVybiBpZD0iZ3JpZDEyODAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CiAgICA8cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjAuNSIgb3BhY2l0eT0iMC4xNSIvPgogIDwvcGF0dGVybj4KICA8cmVjdCB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIGZpbGw9InVybCgjZ3JpZDEyODApIi8+CiAgPCEtLSBTY2FuIGxpbmVzIC0tPgogIDxyZWN0IHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjcyMCIgZmlsbD0idXJsKCNzY2FuMTI4MCkiIG9wYWNpdHk9IjAuMSIvPgogIDwhLS0gQm9yZGVyIC0tPgogIDxyZWN0IHg9IjIiIHk9IjIiIHdpZHRoPSIxMjc2IiBoZWlnaHQ9IjcxNiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNiIvPgogIDwhLS0gQ29ybmVyIGFjY2VudHMgLS0+CiAgPHBhdGggZD0iTSAxMCAxMCBMIDMwIDEwIEwgMzAgMzAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8cGF0aCBkPSJNIDEyNzAgMTAgTCAxMjUwIDEwIEwgMTI1MCAzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjRjOGZmIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuOCIvPgogIDxwYXRoIGQ9Ik0gMTAgNzEwIEwgMzAgNzEwIEwgMzAgNjkwIiBmaWxsPSJub25lIiBzdHJva2U9IiM2NGM4ZmYiIHN0cm9rZS13aWR0aD0iMyIgb3BhY2l0eT0iMC44Ii8+CiAgPHBhdGggZD0iTSAxMjcwIDcxMCBMIDEyNTAgNzEwIEwgMTI1MCA2OTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY0YzhmZiIgc3Ryb2tlLXdpZHRoPSIzIiBvcGFjaXR5PSIwLjgiLz4KICA8IS0tIEljb24gLS0+CiAgPHRleHQgeD0iNjQwIiB5PSIzNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iOTAiIGZpbGw9InVybCgjdGV4dEdyYWQxMjgwKSIgZmlsdGVyPSJ1cmwoI2dsb3cxMjgwKSI+8J+TmjwvdGV4dD4KICA8IS0tIE1haW4gdGV4dCAtLT4KICA8dGV4dCB4PSI2NDAiIHk9IjM3MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IidDb3VyaWVyIE5ldycsIG1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9InVybCgjdGV4dEdyYWQxMjgwKSIgZmlsdGVyPSJ1cmwoI2dsb3cxMjgwKSI+U1RBQ0tJTkcgSFEgRlJBTUVTLi4uPC90ZXh0PgogIDwhLS0gU3RhdHVzIGluZGljYXRvciAtLT4KICA8Y2lyY2xlIGN4PSIxMjUwIiBjeT0iMzAiIHI9IjQiIGZpbGw9IiMwMGZmMDAiIG9wYWNpdHk9IjAuOCI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiB2YWx1ZXM9IjAuODswLjM7MC44IiBkdXI9IjJzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogIDwvY2lyY2xlPgogIDwhLS0gTG9hZGluZyBhbmltYXRpb24gLS0+CiAgPHJlY3QgeD0iNTkwIiB5PSIzODUiIHdpZHRoPSIxMDAiIGhlaWdodD0iNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBmZmZmIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNSIvPgogIDxyZWN0IHg9IjU5MCIgeT0iMzg1IiB3aWR0aD0iMjAiIGhlaWdodD0iNCIgZmlsbD0iIzY0YzhmZiI+CiAgICA8YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InRyYW5zbGF0ZSIgdmFsdWVzPSIwLDA7IDgwLDA7IDAsMCIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICA8L3JlY3Q+Cjwvc3ZnPg=="
                                     onclick="toggleStackedFullscreen('hq')" style="cursor: pointer;">
                                <div class="camera-overlay">Stacked HQ</div>
                            </div>
                            <div class="control-group">
                                <label for="hq-stack-count">Stack Count</label>
                                <input type="range" id="hq-stack-count" class="control-input" 
                                       min="2" max="1000" step="1" value="5"
                                       oninput="updateStackCount('hq')">
                                <div class="range-display">
                                    <span>2</span>
                                    <span id="hq-stack-count-value">5</span>
                                    <span>1000</span>
                                </div>
                            </div>
                            <div class="control-group">
                                <small class="text-muted">📊 Default: Average stacking blends all frames equally</small>
                            </div>
                            <div class="control-group">
                                <label title="Keeps the brightest pixel from each frame - simulates long exposure photography. Good for capturing motion trails and star trails.">
                                    <input type="checkbox" id="hq-long-exposure" onchange="toggleLongExposure('hq')">
                                    🌌 Long Exposure Mode
                                </label>
                            </div>
                            <div class="control-group">
                                <label title="Adds brightness from each frame together (30% per frame) - creates artistic light painting effects. Use with fewer frames (3-5) to avoid overexposure.">
                                    <input type="checkbox" id="hq-juiced-exposure" onchange="toggleJuicedExposure('hq')">
                                    🔥 Juiced Exposure Mode
                                </label>
                            </div>
                            <div class="control-group">
                                <label title="Ignore frame count limit - disable stack count and use all available frames">
                                    <input type="checkbox" id="hq-ignore-count" onchange="toggleIgnoreCount('hq')">
                                    🔓 Ignore Count Limit
                                </label>
                            </div>
                            <div class="btn-group">
                                <!-- Client-side stacking controls -->
                                <button class="btn btn-success" onclick="saveStackedImage('hq')">💾 Save Stack</button>
                                <button class="btn btn-warning" onclick="clearStackingBuffer('hq')">🗑️ Clear Buffer</button>
                                <button class="btn btn-info" onclick="updateStackedImage('hq')">🔄 Stack Now</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aligned Mode -->
                <div id="aligned-cameras" style="display: none;">
                    <div class="camera-panel" style="grid-column: 1 / -1;">
                        <h3>🎯 Feature Aligned View</h3>
                        <div class="camera-preview">
                            <img id="aligned-preview" alt="Aligned Cameras">
                            <div class="camera-overlay">Feature Aligned</div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="show-features" onchange="toggleFeatureDisplay()">
                                <label for="show-features">Show Feature Points</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="alignment-method">Alignment Method</label>
                            <select id="alignment-method" class="control-input" onchange="updateAlignmentMethod()">
                                <option value="orb">ORB Features</option>
                                <option value="sift">SIFT Features</option>
                                <option value="surf">SURF Features</option>
                                <option value="phase">Phase Correlation</option>
                            </select>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="startAlignment()">▶️ Start Alignment</button>
                            <button class="btn btn-danger" onclick="stopAlignment()">⏹️ Stop</button>
                            <button class="btn btn-warning" onclick="saveAlignedImage()">💾 Save Aligned</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Controls Section -->
        <div id="controls" class="content-section">
            <div class="camera-grid">
                <!-- IR Camera Controls -->
                <div class="camera-panel">
                    <h3>📡 IR Camera Controls</h3>
                    <span id="ir-control-status" class="status-indicator"></span>
                    
                    <!-- Live Preview in Controls -->
                    <div class="camera-preview" style="margin-bottom: 15px;">
                        <img id="ir-control-preview" src="http://10.0.1.164:5001/ir_feed" alt="IR Camera Preview">
                        <div class="camera-overlay">IR Preview</div>
                    </div>
                    
                    <div class="control-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ir-auto-exposure" onchange="updateAutoExposure('ir'); applySettings('ir')">
                            <label for="ir-auto-exposure">Auto Exposure</label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="ir-exposure">Exposure Time</label>
                        <input type="range" id="ir-exposure" class="control-input" 
                               min="1" max="10000000" step="1" value="20000"
                               oninput="updateExposureDisplay('ir'); applySettings('ir')">
                        <span id="ir-exposure-display" class="value-display">20ms</span>
                        <div class="range-display">
                            <span>1µs</span>
                            <span id="ir-exposure-value">20ms</span>
                            <span>10s</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="ir-gain">Analogue Gain</label>
                        <input type="range" id="ir-gain" class="control-input" 
                               min="1" max="10.9" step="0.1" value="4.0"
                               oninput="updateGainDisplay('ir'); applySettings('ir')">
                        <span id="ir-gain-display" class="value-display">4.0x</span>
                        <div class="range-display">
                            <span>1.0x</span>
                            <span id="ir-gain-value">4.0x</span>
                            <span>10.9x</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="ir-brightness">Brightness</label>
                        <input type="range" id="ir-brightness" class="control-input" 
                               min="-1" max="1" step="0.1" value="0.5"
                               oninput="updateBrightnessDisplay('ir'); applySettings('ir')">
                        <div class="range-display">
                            <span>Dark</span>
                            <span id="ir-brightness-value">0.5</span>
                            <span>Bright</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="ir-contrast">Contrast</label>
                        <input type="range" id="ir-contrast" class="control-input" 
                               min="0" max="2" step="0.1" value="1.2"
                               oninput="updateContrastDisplay('ir'); applySettings('ir')">
                        <div class="range-display">
                            <span>0.0x</span>
                            <span id="ir-contrast-value">1.2x</span>
                            <span>2.0x</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button id="ir-dynamic-toggle" class="btn btn-info" onclick="toggleDynamicMode('ir')">📊 Dynamic Mode</button>
                        <button class="btn btn-primary" onclick="setDayMode('ir')">☀️ Day</button>
                        <button class="btn btn-dark" onclick="setNightMode('ir')">🌙 Night</button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="autoTuneCamera('ir', false)" title="Comprehensive auto-tuning with multiple samples">🎯 Auto-Tune</button>
                        <button class="btn btn-warning" onclick="autoTuneCamera('ir', true)" title="Quick auto-tuning with fewer samples">⚡ Quick Tune</button>
                        <button class="btn btn-secondary" onclick="fineTuneCamera('ir')" title="Fine-tune current settings">🔧 Fine-Tune</button>
                    </div>
                </div>

                <!-- HQ Camera Controls -->
                <div class="camera-panel">
                    <h3>📷 HQ Camera Controls</h3>
                    <span id="hq-control-status" class="status-indicator"></span>
                    
                    <!-- Live Preview in Controls -->
                    <div class="camera-preview" style="margin-bottom: 15px;">
                        <img id="hq-control-preview" src="http://10.0.1.164:5001/hq_feed" alt="HQ Camera Preview">
                        <div class="camera-overlay">HQ Preview</div>
                    </div>
                    
                    <div class="control-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="hq-auto-exposure" onchange="updateAutoExposure('hq'); applySettings('hq')">
                            <label for="hq-auto-exposure">Auto Exposure</label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="hq-exposure">Exposure Time</label>
                        <input type="range" id="hq-exposure" class="control-input" 
                               min="1" max="30000000" step="1" value="20000"
                               oninput="updateExposureDisplay('hq'); applySettings('hq')">
                        <span id="hq-exposure-display" class="value-display">20ms</span>
                        <div class="range-display">
                            <span>1µs</span>
                            <span id="hq-exposure-value">20ms</span>
                            <span>30s</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="hq-gain">Analogue Gain</label>
                        <input type="range" id="hq-gain" class="control-input" 
                               min="1" max="22.3" step="0.1" value="4.0"
                               oninput="updateGainDisplay('hq'); applySettings('hq')">
                        <span id="hq-gain-display" class="value-display">4.0x</span>
                        <div class="range-display">
                            <span>1.0x</span>
                            <span id="hq-gain-value">4.0x</span>
                            <span>22.3x</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="hq-brightness">Brightness</label>
                        <input type="range" id="hq-brightness" class="control-input" 
                               min="-1" max="1" step="0.1" value="0.5"
                               oninput="updateBrightnessDisplay('hq'); applySettings('hq')">
                        <div class="range-display">
                            <span>Dark</span>
                            <span id="hq-brightness-value">0.5</span>
                            <span>Bright</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="hq-contrast">Contrast</label>
                        <input type="range" id="hq-contrast" class="control-input" 
                               min="0" max="2" step="0.1" value="1.2"
                               oninput="updateContrastDisplay('hq'); applySettings('hq')">
                        <div class="range-display">
                            <span>0.0x</span>
                            <span id="hq-contrast-value">1.2x</span>
                            <span>2.0x</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button id="hq-dynamic-toggle" class="btn btn-info" onclick="toggleDynamicMode('hq')">📊 Dynamic Mode</button>
                        <button class="btn btn-primary" onclick="setDayMode('hq')">☀️ Day</button>
                        <button class="btn btn-dark" onclick="setNightMode('hq')">🌙 Night</button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="autoTuneCamera('hq', false)" title="Comprehensive auto-tuning with multiple samples">🎯 Auto-Tune</button>
                        <button class="btn btn-warning" onclick="autoTuneCamera('hq', true)" title="Quick auto-tuning with fewer samples">⚡ Quick Tune</button>
                        <button class="btn btn-secondary" onclick="fineTuneCamera('hq')" title="Fine-tune current settings">🔧 Fine-Tune</button>
                    </div>
                </div>
                
                <!-- Pan/Tilt Controls -->
                <div class="camera-panel">
                    <h3>🎯 Pan/Tilt Controls</h3>
                    <span id="pantilt-control-status" class="status-indicator"></span>
                    
                    <div class="control-group">
                        <h4>Current Position</h4>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-label">Pan:</span>
                                <span id="pan-position" class="status-value">0.0°</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Tilt:</span>
                                <span id="tilt-position" class="status-value">0.0°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Movement Controls</h4>
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin: 15px 0;">
                            <!-- Top row -->
                            <div></div>
                            <button class="btn btn-secondary" onclick="movePanTilt('move_relative', {tilt_steps: -10})" title="Tilt Up">⬆️</button>
                            <div></div>
                            
                            <!-- Middle row -->
                            <button class="btn btn-secondary" onclick="movePanTilt('move_relative', {pan_steps: -10})" title="Pan Left">⬅️</button>
                            <button class="btn btn-primary" onclick="movePanTilt('home')" title="Home">🏠</button>
                            <button class="btn btn-secondary" onclick="movePanTilt('move_relative', {pan_steps: 10})" title="Pan Right">➡️</button>
                            
                            <!-- Bottom row -->
                            <div></div>
                            <button class="btn btn-secondary" onclick="movePanTilt('move_relative', {tilt_steps: 10})" title="Tilt Down">⬇️</button>
                            <div></div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Step Size Control</h4>
                        <div class="control-row">
                            <label for="step-size">Movement Step Size</label>
                            <input type="range" id="step-size" class="control-input" 
                                   min="1" max="10" step="1" value="5"
                                   oninput="updateStepSize()">
                            <div class="range-display">
                                <span>1</span>
                                <span id="step-size-value">5</span>
                                <span>10</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="pantilt-speed">Movement Speed</label>
                        <input type="range" id="pantilt-speed" class="control-input" 
                               min="50" max="255" step="5" value="100"
                               oninput="updatePanTiltSpeed()">
                        <div class="range-display">
                            <span>Slow</span>
                            <span id="pantilt-speed-value">100</span>
                            <span>Fast</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Motor Control</h4>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success" id="motor-toggle-btn" onclick="toggleMotors()">🔌 Enable Motors</button>
                            <button class="btn btn-danger" id="keepalive-toggle-btn" onclick="toggleKeepalive()">🔒 Keep Motors On</button>
                        </div>
                        <div id="motor-status" style="margin-top: 10px; padding: 5px; border-radius: 5px; background: rgba(255,255,255,0.1);">
                            <strong>Motors:</strong> <span id="motor-state">Unknown</span><br>
                            <strong>Keep On Mode:</strong> <span id="keepalive-state">Inactive</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="refreshPanTiltStatus()">🔄 Refresh Status</button>
                        <button class="btn btn-secondary" onclick="togglePanTiltAutoRefresh()">⏰ Auto: OFF</button>
                    </div>
                </div>
                
                <!-- Compass & Trajectory Controls -->
                <div class="camera-panel">
                    <h3>🧭 Compass & Trajectory Controls</h3>
                    
                    <div class="control-group">
                        <h4>Compass Calibration</h4>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-label">Heading:</span>
                                <span id="compass-heading" class="status-value">--°</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Status:</span>
                                <span id="compass-status" class="status-value">Not Calibrated</span>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="calibrateCompass()">🎯 Point North & Calibrate</button>
                            <button class="btn btn-info" onclick="updateCompassReading()">🔄 Update Reading</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Field of View Settings</h4>
                        <label for="fov-horizontal">Horizontal FOV (degrees)</label>
                        <input type="range" id="fov-horizontal" class="control-input" 
                               min="30" max="360" step="5" value="180"
                               oninput="updateFOV()">
                        <div class="range-display">
                            <span>30°</span>
                            <span id="fov-h-value">180°</span>
                            <span>360°</span>
                        </div>
                        
                        <label for="fov-vertical">Vertical FOV (degrees)</label>
                        <input type="range" id="fov-vertical" class="control-input" 
                               min="20" max="180" step="5" value="90"
                               oninput="updateFOV()">
                        <div class="range-display">
                            <span>20°</span>
                            <span id="fov-v-value">90°</span>
                            <span>180°</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Trajectory Projection</h4>
                        <div class="btn-group">
                            <button id="trajectory-toggle" class="btn btn-success" onclick="toggleTrajectoryOverlay()">
                                🚀 Enable Trajectories
                            </button>
                            <button class="btn btn-secondary" onclick="refreshTrajectories()">🔄 Refresh</button>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="show-satellites" checked onchange="updateTrajectorySettings()">
                                Show Satellites
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="show-aircraft" checked onchange="updateTrajectorySettings()">
                                Show Aircraft (ADS-B)
                            </label>
                        </div>
                        
                        <div id="trajectory-status" style="margin-top: 10px; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1);">
                            <strong>Satellites Visible:</strong> <span id="sat-count">--</span><br>
                            <strong>Aircraft Tracked:</strong> <span id="aircraft-count">--</span><br>
                            <strong>Projection Status:</strong> <span id="projection-status">Disabled</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Gallery Section -->
        <div id="gallery" class="content-section">
            <div class="status-panel">
                <h2>🖼️ Image Gallery</h2>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="refreshGallery()">🔄 Refresh</button>
                    <button class="btn btn-warning" onclick="clearGallery()">🗑️ Clear All</button>
                    <button class="btn btn-info" onclick="exportGallery()">📤 Export</button>
                </div>
                
                <div class="storage-info" style="margin-bottom: 20px;">
                    <p>Storage: <span id="storage-used">Loading...</span> | Images: <span id="image-count">Loading...</span></p>
                </div>
                
                <div id="gallery-content" class="gallery-grid">
                    <div class="loading-message">Loading images...</div>
                </div>
            </div>
        </div>

        <!-- System Settings Section -->
        <div id="settings" class="content-section">
            <div class="status-panel">
                <h2>🔧 System Settings</h2>
                
                <div class="control-group">
                    <label for="refresh-interval">Auto Refresh Interval (seconds)</label>
                    <input type="range" id="refresh-interval" class="control-input" 
                           min="1" max="10" step="1" value="2"
                           oninput="updateRefreshInterval()">
                    <div class="range-display">
                        <span>1s</span>
                        <span id="refresh-interval-value">2s</span>
                        <span>10s</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="night-mode" onchange="toggleNightMode()">
                        <label for="night-mode">Night Mode</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="sound-alerts" onchange="toggleSoundAlerts()">
                        <label for="sound-alerts">Sound Alerts</label>
                    </div>
                </div>
                
                <!-- Storage Management -->
                <div class="control-group">
                    <h3>💾 Storage Management</h3>
                    <p style="font-size: 14px; color: #999; margin-bottom: 10px;">Manage detection image storage and free up disk space</p>
                    
                    <div style="margin-bottom: 15px;">
                        <div id="gallery-stats" style="font-size: 12px; color: #ccc;">
                            Loading gallery statistics...
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="clearAllGalleryFiles()" style="margin-bottom: 10px;">
                            🗑️ Clear All Images (Permanent)
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #ff9999; margin-top: 5px;">
                        ⚠️ This will permanently delete ALL detection images and cannot be undone!
                    </p>
                </div>
                
                <!-- Timelapse Controls -->
                <div class="control-group">
                    <h3>🎬 Timelapse System</h3>
                    <p style="font-size: 14px; color: #999; margin-bottom: 15px;">Automatic hourly timelapse video generation</p>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-label">Service Status:</span>
                                <span id="timelapse-status" class="status-value">Loading...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Current Hour:</span>
                                <span id="current-hour" class="status-value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Videos Created:</span>
                                <span id="videos-count" class="status-value">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="startTimelapseService()">▶️ Start Service</button>
                        <button class="btn btn-danger" onclick="stopTimelapseService()">⏹️ Stop Service</button>
                        <button class="btn btn-info" onclick="refreshTimelapseStatus()">🔄 Refresh Status</button>
                        <button class="btn btn-warning" onclick="cleanupOldTimelapses()">🗑️ Cleanup Old</button>
                    </div>
                    
                    <div id="timelapse-videos-list" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 10px;">
                        <div style="text-align: center; color: #999;">Loading timelapse videos...</div>
                    </div>
                </div>
                
                <!-- Music Effects Controls -->
                <div class="control-group">
                    <h3>🎵 Music Effects</h3>
                    <p style="font-size: 14px; color: #999; margin-bottom: 15px;">Audio effects for ambient music generation</p>
                    
                    <!-- Effect Presets -->
                    <div style="margin-bottom: 15px;">
                        <label>Effect Presets:</label>
                        <div class="btn-group" style="margin-top: 5px;">
                            <button class="btn btn-sm btn-secondary" onclick="setMusicEffectPreset('ambient')">🌙 Ambient</button>
                            <button class="btn btn-sm btn-secondary" onclick="setMusicEffectPreset('space')">🌌 Space</button>
                            <button class="btn btn-sm btn-secondary" onclick="setMusicEffectPreset('ethereal')">✨ Ethereal</button>
                            <button class="btn btn-sm btn-secondary" onclick="setMusicEffectPreset('dreamy')">☁️ Dreamy</button>
                            <button class="btn btn-sm btn-secondary" onclick="setMusicEffectPreset('cosmic')">🪐 Cosmic</button>
                        </div>
                    </div>
                    
                    <!-- Individual Effect Controls -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- Reverb -->
                        <div class="effect-control">
                            <div class="checkbox-group">
                                <input type="checkbox" id="effect-reverb" onchange="toggleMusicEffect('reverb', this.checked)" checked>
                                <label for="effect-reverb">🏛️ Reverb</label>
                            </div>
                            <input type="range" id="reverb-level" min="0" max="1" step="0.1" value="0.3" 
                                   oninput="setMusicEffectParam('reverb', 'level', this.value)">
                            <span class="effect-value" id="reverb-level-display">30%</span>
                        </div>
                        
                        <!-- Chorus -->
                        <div class="effect-control">
                            <div class="checkbox-group">
                                <input type="checkbox" id="effect-chorus" onchange="toggleMusicEffect('chorus', this.checked)">
                                <label for="effect-chorus">🎭 Chorus</label>
                            </div>
                            <input type="range" id="chorus-level" min="0" max="1" step="0.1" value="0.4" 
                                   oninput="setMusicEffectParam('chorus', 'level', this.value)">
                            <span class="effect-value" id="chorus-level-display">40%</span>
                        </div>
                        
                        <!-- Flanger -->
                        <div class="effect-control">
                            <div class="checkbox-group">
                                <input type="checkbox" id="effect-flanger" onchange="toggleMusicEffect('flanger', this.checked)">
                                <label for="effect-flanger">🌊 Flanger</label>
                            </div>
                            <input type="range" id="flanger-level" min="0" max="1" step="0.1" value="0.3" 
                                   oninput="setMusicEffectParam('flanger', 'level', this.value)">
                            <span class="effect-value" id="flanger-level-display">30%</span>
                        </div>
                        
                        <!-- Delay -->
                        <div class="effect-control">
                            <div class="checkbox-group">
                                <input type="checkbox" id="effect-delay" onchange="toggleMusicEffect('delay', this.checked)">
                                <label for="effect-delay">⏰ Delay</label>
                            </div>
                            <input type="range" id="delay-level" min="0" max="1" step="0.1" value="0.2" 
                                   oninput="setMusicEffectParam('delay', 'level', this.value)">
                            <span class="effect-value" id="delay-level-display">20%</span>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSettings()">💾 Save Settings</button>
                    <button class="btn btn-secondary" onclick="resetSettings()">🔄 Reset</button>
                    <button class="btn btn-warning" onclick="exportConfig()">📤 Export Config</button>
                    <button class="btn btn-danger" onclick="restartSystem()">🔄 Restart System</button>
                </div>
            </div>
        </div>
    </div>

    <!-- External JavaScript files -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/core.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/camera-feeds.js"></script>
    <script src="/static/js/unified-music-engine.js"></script>
    <script src="/static/js/mood-music.js"></script>
    <script src="/static/js/camera-controls.js"></script>
    <script src="/static/js/pantilt-controls.js"></script>
    <script src="/static/js/tracking.js"></script>
    <script src="/static/js/feature-tracking.js"></script>
    <script src="/static/js/trajectory-overlay.js"></script>
    <script src="/static/js/compass-trajectory.js"></script>
    <script src="/static/js/motion-detection.js"></script>
    <script src="/static/js/gallery.js"></script>
    <script src="/static/js/stacking-optimized.js"></script>
    <script src="/static/js/adsb-tracker.js"></script>
    
    <script>
        // Server IP passed from Flask - needed by all modules
        const serverIP = '{{ server_ip }}';
        window.serverIP = serverIP;  // Make available globally for other scripts
        console.log('Server IP:', serverIP);
        
        // Music Effects Control Functions
        function setMusicEffectPreset(presetName) {
            if (typeof unifiedMusic !== 'undefined') {
                unifiedMusic.setPresetEffects(presetName);
                updateEffectControlsUI();
                showMessage(`Music effects preset "${presetName}" applied`, 'info');
            }
        }
        
        function toggleMusicEffect(effectName, enabled) {
            if (typeof unifiedMusic !== 'undefined') {
                unifiedMusic.setEffectEnabled(effectName, enabled);
                showMessage(`${effectName} effect ${enabled ? 'enabled' : 'disabled'}`, 'info');
            }
        }
        
        function setMusicEffectParam(effectName, parameter, value) {
            if (typeof unifiedMusic !== 'undefined') {
                const numValue = parseFloat(value);
                unifiedMusic.setEffectParameter(effectName, parameter, numValue);
                
                // Update display
                const displayElement = document.getElementById(`${effectName}-${parameter}-display`);
                if (displayElement) {
                    displayElement.textContent = Math.round(numValue * 100) + '%';
                }
            }
        }
        
        function updateEffectControlsUI() {
            if (typeof unifiedMusic !== 'undefined' && unifiedMusic.effects) {
                Object.keys(unifiedMusic.effects).forEach(effectName => {
                    const effect = unifiedMusic.effects[effectName];
                    
                    // Update checkbox
                    const checkbox = document.getElementById(`effect-${effectName}`);
                    if (checkbox) {
                        checkbox.checked = effect.enabled;
                    }
                    
                    // Update level slider and display
                    Object.keys(effect).forEach(param => {
                        if (param !== 'enabled') {
                            const slider = document.getElementById(`${effectName}-${param}`);
                            const display = document.getElementById(`${effectName}-${param}-display`);
                            
                            if (slider && typeof effect[param] === 'number') {
                                slider.value = effect[param];
                            }
                            if (display && typeof effect[param] === 'number') {
                                display.textContent = Math.round(effect[param] * 100) + '%';
                            }
                        }
                    });
                });
            }
        }
        
        // Timelapse Control Functions
        function refreshTimelapseStatus() {
            fetch('/api/timelapse/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const status = data.status;
                        document.getElementById('timelapse-status').textContent = status.running ? 'Running' : 'Stopped';
                        document.getElementById('timelapse-status').style.color = status.running ? '#4CAF50' : '#666';
                        document.getElementById('current-hour').textContent = status.current_hour || '--';
                    }
                })
                .catch(error => {
                    console.error('Error fetching timelapse status:', error);
                    document.getElementById('timelapse-status').textContent = 'Error';
                    document.getElementById('timelapse-status').style.color = '#ff6b6b';
                });
                
            // Also refresh videos list
            refreshTimelapseVideos();
        }
        
        function refreshTimelapseVideos() {
            fetch('/api/timelapse/videos')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const videos = data.videos;
                        document.getElementById('videos-count').textContent = videos.length;
                        
                        const videosList = document.getElementById('timelapse-videos-list');
                        if (videos.length === 0) {
                            videosList.innerHTML = '<div style="text-align: center; color: #999;">No timelapse videos found</div>';
                        } else {
                            videosList.innerHTML = videos.slice(0, 10).map(video => `
                                <div style="display: flex; justify-content: between; align-items: center; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <div style="flex: 1;">
                                        <strong>${video.name}</strong><br>
                                        <small style="color: #999;">${video.type} | ${formatBytes(video.size)} | ${new Date(video.date).toLocaleString()}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary" onclick="playTimelapseVideo('${video.url}')">▶️</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTimelapseVideo('${video.name}')">🗑️</button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching timelapse videos:', error);
                });
        }
        
        function playTimelapseVideo(url) {
            window.open(url, '_blank');
        }
        
        function deleteTimelapseVideo(filename) {
            if (confirm(`Delete timelapse video "${filename}"?`)) {
                fetch('/api/timelapse/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        refreshTimelapseVideos();
                    } else {
                        showMessage(data.error, 'error');
                    }
                });
            }
        }
        
        function cleanupOldTimelapses() {
            if (confirm('Delete timelapse videos older than 7 days?')) {
                fetch('/api/timelapse/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: 7})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        refreshTimelapseVideos();
                    } else {
                        showMessage(data.error, 'error');
                    }
                });
            }
        }
        
        function startTimelapseService() {
            showMessage('Timelapse service management is handled by system services', 'info');
            // In production, this would start the actual service
        }
        
        function stopTimelapseService() {
            showMessage('Timelapse service management is handled by system services', 'info');
            // In production, this would stop the actual service
        }
        
        // Motion Detection Control Functions
        function toggleAutoCapture() {
            const checkbox = document.getElementById('auto-capture-enabled');
            if (typeof autoCapture !== 'undefined') {
                autoCapture.enabled = checkbox.checked;
                showMessage(`Auto-capture ${checkbox.checked ? 'enabled' : 'disabled'}`, 'info');
            }
        }
        
        function updateCaptureThreshold() {
            const input = document.getElementById('capture-threshold');
            if (typeof autoCapture !== 'undefined') {
                autoCapture.threshold = parseInt(input.value) || 2;
                showMessage(`Capture threshold set to ${autoCapture.threshold} objects`, 'info');
            }
        }
        
        function testMotionDetection() {
            // Simulate motion detection for testing
            const testAreas = [
                {x: 100, y: 100, width: 50, height: 50, intensity: 75},
                {x: 200, y: 150, width: 40, height: 60, intensity: 85}
            ];
            
            if (typeof captureMotionSnapshot === 'function') {
                captureMotionSnapshot(testAreas, 'hq');
                showMessage('Test motion detection snapshot captured', 'success');
            }
        }
        
        function updateSensitivity() {
            const slider = document.getElementById('motion-sensitivity');
            const display = document.getElementById('sensitivity-display');
            
            if (slider && display) {
                const value = parseInt(slider.value);
                display.textContent = value;
                
                // Update global motion sensitivity
                if (typeof motionSensitivity !== 'undefined') {
                    motionSensitivity = value;
                }
                
                // Update status display
                const statusElement = document.getElementById('sensitivity-value');
                if (statusElement) {
                    let level = 'Low';
                    if (value > 30) level = 'Medium';
                    if (value > 60) level = 'High';
                    statusElement.textContent = level;
                }
            }
        }
        
        // Utility function for file size formatting
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Motion Detection Section Functions
        let motionSnapshotCount = 0;
        
        function toggleMotionDetection() {
            const btn = document.getElementById('motion-enable-btn');
            if (!motionDetectionActive) {
                // Start motion detection
                if (typeof startClientMotionDetection === 'function') {
                    startClientMotionDetection();
                    motionDetectionActive = true;
                    btn.textContent = '⏹️ Stop Detection';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');
                    showMessage('Motion detection started', 'success');
                    
                    // Initialize motion feeds
                    initializeMotionFeeds();
                }
            } else {
                // Stop motion detection
                if (typeof stopClientMotionDetection === 'function') {
                    stopClientMotionDetection();
                    motionDetectionActive = false;
                    btn.textContent = '🎯 Enable Detection';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                    showMessage('Motion detection stopped', 'info');
                }
            }
        }
        
        function initializeMotionFeeds() {
            console.log('Initializing motion detection feeds');
            
            // Set up motion detection feeds with MJPEG streams from port 5001
            const irImg = document.getElementById('motion-ir-feed');
            const hqImg = document.getElementById('motion-hq-feed');
            
            if (irImg) {
                irImg.src = `http://${serverIP}:5001/ir_feed?t=${Date.now()}`;
                console.log('IR motion feed initialized with:', irImg.src);
            }
            
            if (hqImg) {
                hqImg.src = `http://${serverIP}:5001/hq_feed?t=${Date.now()}`;
                console.log('HQ motion feed initialized with:', hqImg.src);
            }
            
            // Initialize motion detection canvases if the function exists
            if (typeof initializeMotionDetection === 'function') {
                setTimeout(() => {
                    initializeMotionDetection();
                }, 1000);
            }
        }
        
        function refreshMotionFeed(camera) {
            const img = document.getElementById(`motion-${camera}-feed`);
            if (img) {
                // Use MJPEG feeds from port 5001 for continuous streaming
                img.src = `http://${serverIP}:5001/${camera}_feed?t=${Date.now()}`;
                console.log(`${camera} motion feed refreshed with:`, img.src);
            }
        }
        
        function captureMotionFrame(camera) {
            const currentMotionAreas = typeof motionState !== 'undefined' && motionState.ir.motionAreas ? 
                                      motionState.ir.motionAreas : [];
            
            if (typeof captureMotionSnapshot === 'function') {
                captureMotionSnapshot(currentMotionAreas, camera);
                motionSnapshotCount++;
                document.getElementById('motion-snapshots-count').textContent = motionSnapshotCount;
            }
        }
        
        // Motion Detection page button functions
        function toggleDetection() {
            if (typeof startClientMotionDetection === 'function' && typeof stopClientMotionDetection === 'function') {
                if (motionDetectionActive) {
                    stopClientMotionDetection();
                    showMessage('Motion detection stopped', 'info');
                } else {
                    startClientMotionDetection();
                    showMessage('Motion detection started', 'success');
                }
            } else {
                showMessage('Motion detection functions not available', 'error');
            }
        }
        
        function refreshDetectionStatus() {
            // Refresh the feeds
            refreshMotionFeed('ir');
            refreshMotionFeed('hq');
            showMessage('Detection status refreshed', 'info');
        }
        
        function adjustSensitivity() {
            const slider = document.getElementById('motion-sensitivity-slider');
            if (slider) {
                const value = prompt('Enter sensitivity value (10-100):', slider.value || '40');
                if (value && !isNaN(value)) {
                    const numValue = parseInt(value);
                    if (numValue >= 10 && numValue <= 100) {
                        slider.value = numValue;
                        if (typeof updateMotionSensitivity === 'function') {
                            updateMotionSensitivity();
                        }
                        showMessage(`Sensitivity set to ${numValue}`, 'success');
                    } else {
                        showMessage('Sensitivity must be between 10 and 100', 'error');
                    }
                }
            } else {
                showMessage('Sensitivity control not found', 'error');
            }
        }
        
        function clearDetections() {
            if (typeof clearOverlays === 'function') {
                clearOverlays();
                showMessage('Detection overlays cleared', 'info');
            } else {
                showMessage('Clear function not available', 'error');
            }
        }
        
        function updateMotionSensitivity() {
            const slider = document.getElementById('motion-sensitivity-slider');
            const display = document.getElementById('motion-sensitivity-display');
            const levelDisplay = document.getElementById('motion-sensitivity-level');
            
            if (slider && display) {
                const value = parseInt(slider.value);
                display.textContent = value;
                
                // Update motion sensitivity globally
                if (typeof motionSensitivity !== 'undefined') {
                    motionSensitivity = value;
                }
                
                // Update level display
                if (levelDisplay) {
                    let level = 'Low';
                    if (value > 30) level = 'Medium';
                    if (value > 60) level = 'High';
                    levelDisplay.textContent = level;
                }
            }
        }
        
        function updateMotionCaptureThreshold() {
            const input = document.getElementById('motion-capture-threshold');
            if (input && typeof autoCapture !== 'undefined') {
                autoCapture.threshold = parseInt(input.value) || 2;
                showMessage(`Capture threshold set to ${autoCapture.threshold} objects`, 'info');
            }
        }
        
        function toggleMotionAutoCapture() {
            const checkbox = document.getElementById('motion-auto-capture');
            if (checkbox && typeof autoCapture !== 'undefined') {
                autoCapture.enabled = checkbox.checked;
                showMessage(`Auto-capture ${checkbox.checked ? 'enabled' : 'disabled'}`, 'info');
            }
        }
        
        function clearMotionOverlays() {
            if (typeof clearOverlays === 'function') {
                clearOverlays();
                showMessage('Motion overlays cleared', 'info');
            }
        }
        
        function captureMotionSnapshot() {
            const camera = document.getElementById('motion-capture-camera')?.value || 'hq';
            
            // Direct API call to capture snapshot
            fetch('/api/motion/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera: camera })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    motionSnapshotCount++;
                    document.getElementById('motion-snapshots-count').textContent = motionSnapshotCount;
                    showMessage(`Motion snapshot captured: ${data.filename}`, 'success');
                } else {
                    showMessage(`Failed to capture snapshot: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showMessage(`Error capturing snapshot: ${error}`, 'error');
                console.error('Capture error:', error);
            });
        }
        
        // Update motion detection stats periodically
        function updateMotionStats() {
            if (motionDetectionActive && typeof processingFPS !== 'undefined') {
                document.getElementById('motion-processing-fps').textContent = processingFPS || 0;
                
                if (typeof motionState !== 'undefined' && motionState.ir.motionAreas) {
                    document.getElementById('motion-objects-detected').textContent = motionState.ir.motionAreas.length;
                }
            }
        }
        
        // Initialize timelapse status on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                refreshTimelapseStatus();
                // Start motion stats updates
                setInterval(updateMotionStats, 1000);
            }, 1000);
        });
        
        // Status bar music controls - use window object to avoid conflicts
        window.statusMusicEnabled = false;
        window.statusMusicPlaying = false;
        window.statusShuffleMode = false;
        
        window.statusPlayMusic = function() {
            try {
                console.log('statusPlayMusic called');
                const playBtn = document.getElementById('status-play-btn');
                
                if (!window.statusMusicEnabled) {
                    window.statusMusicEnabled = true;
                }
                
                if (typeof unifiedMusic !== 'undefined') {
                    unifiedMusic.setEnhancedMode(true); // Default to enhanced mode
                    unifiedMusic.playRandomTrack().then(success => {
                        if (success) {
                            window.statusMusicPlaying = true;
                            if (playBtn) {
                                playBtn.style.color = '#4CAF50';
                            }
                            window.monitorPlaybackForAutoAdvance();
                            console.log('Music started successfully');
                        } else {
                            console.error('Failed to start music');
                        }
                    }).catch(error => {
                        console.error('Error playing music:', error);
                    });
                } else {
                    console.error('unifiedMusic not found');
                }
            } catch (error) {
                console.error('Error in statusPlayMusic:', error);
            }
        }
        
        window.statusNextTrack = function() {
            try {
                console.log('statusNextTrack called');
                if (window.statusMusicEnabled && typeof unifiedMusic !== 'undefined') {
                    unifiedMusic.stop();
                    setTimeout(async () => {
                        const success = await unifiedMusic.playRandomTrack();
                        if (success) {
                            window.statusMusicPlaying = true;
                            window.monitorPlaybackForAutoAdvance();
                            console.log('Next track started');
                        }
                    }, 500);
                } else {
                    console.log('Music not enabled or unifiedMusic not found');
                }
            } catch (error) {
                console.error('Error in statusNextTrack:', error);
            }
        }
        
        window.statusToggleShuffle = function() {
            try {
                console.log('statusToggleShuffle called');
                window.statusShuffleMode = !window.statusShuffleMode;
                const shuffleBtn = document.getElementById('status-shuffle-btn');
                
                if (shuffleBtn) {
                    shuffleBtn.style.color = window.statusShuffleMode ? '#4CAF50' : '';
                    shuffleBtn.title = window.statusShuffleMode ? 'Shuffle: ON' : 'Shuffle: OFF';
                }
                
                localStorage.setItem('musicShuffleMode', window.statusShuffleMode.toString());
                console.log('Shuffle mode:', window.statusShuffleMode ? 'ON' : 'OFF');
            } catch (error) {
                console.error('Error in statusToggleShuffle:', error);
            }
        }
        
        window.statusStopMusic = function() {
            try {
                console.log('statusStopMusic called');
                const playBtn = document.getElementById('status-play-btn');
                
                if (typeof unifiedMusic !== 'undefined') {
                    unifiedMusic.stop();
                }
                
                if (playBtn) {
                    playBtn.style.color = '';
                }
                
                window.statusMusicPlaying = false;
                console.log('Music stopped');
            } catch (error) {
                console.error('Error in statusStopMusic:', error);
            }
        }
        
        // Monitor playback for auto-advance
        window.monitorPlaybackForAutoAdvance = function() {
            const checkStatus = () => {
                if (!window.statusMusicEnabled) return;
                
                const status = unifiedMusic.getStatus();
                if (status.playing) {
                    // Still playing, check again in 2 seconds
                    setTimeout(checkStatus, 2000);
                } else if (window.statusMusicPlaying) {
                    // Track finished, auto-advance
                    console.log('Track finished, auto-advancing...');
                    window.statusNextTrack();
                }
            };
            
            setTimeout(checkStatus, 2000);
        }
        
        // Capture frame function
        function captureFrame(camera) {
            fetch(`/api/capture/${camera}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`Image captured from ${camera.toUpperCase()} camera: ${data.filename}`, 'success');
                    // Refresh gallery if it's visible
                    if (document.getElementById('gallery-content')) {
                        refreshGallery();
                    }
                } else {
                    showMessage(`Failed to capture from ${camera.toUpperCase()}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showMessage(`Error capturing from ${camera.toUpperCase()}: ${error}`, 'error');
                console.error('Capture error:', error);
            });
        }
        
        // Image modal functions
        function openImageModal(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            if (modal && modalImg) {
                modal.style.display = 'block';
                modalImg.src = src;
            }
        }
        
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ADSB Flight Tracker Functions
        function showADSBView() {
            // Simple implementation - show alert with flight data for now
            fetch('/api/adsb/flights')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const flightCount = data.flight_count;
                        const flightInfo = data.flights.slice(0, 5).map(flight => {
                            const callsign = flight.flight !== 'N/A' ? flight.flight : 'Unknown';
                            const altitude = flight.altitude ? Math.round(flight.altitude).toLocaleString() : 'N/A';
                            const distance = flight.distance_miles;
                            const bearing = Math.round(flight.bearing_degrees);
                            return `${callsign}: ${distance} mi, ${altitude} ft, ${bearing}°`;
                        }).join('\n');
                        
                        const message = flightCount > 0 ? 
                            `🛩️ ${flightCount} flights within 10 miles:\n\n${flightInfo}${flightCount > 5 ? '\n... and more' : ''}` :
                            '📡 No flights detected within 10 miles';
                            
                        alert(message);
                    } else {
                        alert('❌ Failed to fetch flight data: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('💥 Error fetching flight data: ' + error.message);
                });
        }
        
        // Show detailed ADSB information in modal/alert
        function showADSBDetails() {
            fetch('/api/adsb/status')
                .then(response => response.json())
                .then(status => {
                    const details = `🛩️ ADSB Flight Tracker Details

📡 Connection Status: ${status.running ? 'Connected' : 'Disconnected'}
🌐 PiAware URL: ${status.piaware_url}
📊 Flights in Range: ${status.flight_count}
📏 Max Range: ${status.max_distance_miles} miles
🕒 Last Update: ${status.last_update ? new Date(status.last_update).toLocaleString() : 'Never'}

📍 Observer Location:
  Latitude: ${status.observer_location?.latitude}°
  Longitude: ${status.observer_location?.longitude}°
  Altitude: ${status.observer_location?.altitude_feet} ft

✅ Status: ${status.enabled ? 'Enabled' : 'Disabled'}`;
                    
                    alert(details);
                })
                .catch(error => {
                    alert('Error fetching ADSB details: ' + error.message);
                });
        }
        
        // Satellite Tracker Functions
        function refreshSatelliteData() {
            fetch('/api/satellite/status')
                .then(response => response.json())
                .then(data => {
                    updateSatelliteWidget(data);
                })
                .catch(error => {
                    console.error('Error fetching satellite data:', error);
                    document.getElementById('satellite-connection-status').textContent = 'Error';
                    document.getElementById('satellite-connection-status').style.color = '#dc3545';
                });
        }
        
        function updateSatelliteWidget(data) {
            // Update status indicator based on new format
            const statusEl = document.getElementById('satellite-connection-status');
            
            if (data.loading) {
                statusEl.textContent = `Loading ${data.progress}%`;
                statusEl.style.color = '#ffc107';
            } else if (data.status === 'ready') {
                statusEl.textContent = 'Active';
                statusEl.style.color = '#28a745';
            } else if (data.status === 'error') {
                statusEl.textContent = 'Error';
                statusEl.style.color = '#dc3545';
            } else if (data.status === 'service_unavailable') {
                statusEl.textContent = 'Service Offline';
                statusEl.style.color = '#6c757d';
            } else {
                statusEl.textContent = 'Unknown';
                statusEl.style.color = '#dc3545';
            }
            
            // Update stats
            document.getElementById('satellite-count').textContent = data.visible_count || 0;
            document.getElementById('satellite-min-elevation').textContent = '10°'; // From config
            
            const lastUpdate = data.last_update ? new Date(data.last_update).toLocaleTimeString() : 'Never';
            document.getElementById('satellite-last-update').textContent = lastUpdate;
            
            // Update satellite list based on loading status
            if (data.loading) {
                displayLoadingProgress(data);
            } else if (data.status === 'ready') {
                // Fetch and display satellite list
                fetch('/api/satellite/overhead')
                    .then(response => response.json())
                    .then(satData => {
                        displaySatelliteList(satData.satellites || []);
                    })
                    .catch(error => {
                        console.error('Error fetching satellite list:', error);
                        displayErrorMessage('Failed to fetch satellites');
                    });
            } else {
                displayErrorMessage(data.error || 'Service unavailable');
            }
        }
        
        function displayLoadingProgress(data) {
            const listEl = document.getElementById('satellite-list');
            const progress = data.progress || 0;
            const loadedCount = data.loaded_satellites || 0;
            const totalCount = data.total_satellites || 0;
            
            let statusText = '';
            if (data.status === 'initializing') {
                statusText = 'Initializing satellite tracker...';
            } else if (data.status === 'loading_satellites') {
                statusText = `Loading satellites... ${loadedCount}/${totalCount}`;
            } else {
                statusText = 'Loading satellite data...';
            }
            
            listEl.innerHTML = `
                <div class="satellite-loading">
                    <p>🛰️ ${statusText}</p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 3px; margin: 10px 0;">
                        <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 20px; border-radius: 7px; width: ${progress}%; transition: width 0.3s ease;"></div>
                    </div>
                    <small>${progress}% complete</small>
                    ${data.next_update ? `<br><small>Next update: ${new Date(data.next_update * 1000).toLocaleTimeString()}</small>` : ''}
                </div>
            `;
        }
        
        function displayErrorMessage(message) {
            const listEl = document.getElementById('satellite-list');
            listEl.innerHTML = `
                <div class="satellite-loading">
                    <p>❌ ${message}</p>
                    <small>Check satellite service status</small>
                </div>
            `;
        }

        function displaySatelliteList(satellites) {
            const listEl = document.getElementById('satellite-list');
            
            if (satellites.length === 0) {
                listEl.innerHTML = '<div class="satellite-loading"><p>🛰️ No satellites above minimum elevation</p><small>Try lowering the elevation threshold</small></div>';
                return;
            }
            
            const html = satellites.map(sat => {
                // Create tracking links based on NORAD ID (more reliable than name)
                const noradId = sat.norad_id;
                const satName = encodeURIComponent(sat.name);
                
                // Use NORAD ID if available, fallback to name search
                const n2yoUrl = noradId ? 
                    `https://www.n2yo.com/satellite/?s=${noradId}` : 
                    `https://www.n2yo.com/satellites/search.php?keyword=${satName}`;
                    
                const celestrakUrl = noradId ? 
                    `https://celestrak.org/satcat/search-results.php?CATNR=${noradId}` : 
                    `https://celestrak.org/satcat/search-results.php?NAME=${satName}`;
                    
                const heavensAboveUrl = noradId ? 
                    `https://heavens-above.com/SatInfo.aspx?satid=${noradId}&lat=0&lng=0&loc=Unspecified&alt=0&tz=UCT` :
                    `https://heavens-above.com/SatSearch.aspx?searchstr=${satName}`;
                
                return `
                    <div class="satellite-item">
                        <div class="flight-header">
                            <span class="satellite-name">${sat.name}</span>
                            <span class="satellite-elevation">${Math.round(sat.elevation)}°</span>
                        </div>
                        <div class="satellite-details">
                            <small>
                                Alt: ${Math.round(sat.distance)} mi | 
                                Az: ${Math.round(sat.azimuth)}° | Vel: ${Math.round(sat.velocity)} mph
                            </small>
                        </div>
                        <div class="satellite-links" style="margin-top: 5px;">
                            <small>
                                <a href="${n2yoUrl}" target="_blank" style="color: #ffa500; margin-right: 8px;">N2YO</a>
                                <a href="${celestrakUrl}" target="_blank" style="color: #ffa500; margin-right: 8px;">CelesTrak</a>
                                <a href="${heavensAboveUrl}" target="_blank" style="color: #ffa500;">Heavens-Above</a>
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            listEl.innerHTML = html;
        }
        
        function showSatelliteDetails() {
            fetch('/api/satellite/status')
                .then(response => response.json())
                .then(status => {
                    let statusText = status.status || 'unknown';
                    if (status.loading) {
                        statusText = `Loading (${status.progress}%)`;
                    }
                    
                    const details = `🛰️ Satellite Tracker Details

📡 Service Status: ${statusText}
🌐 TLE Source: CelesTrak
📊 Satellites Visible: ${status.visible_count || 0}
📊 Total Loaded: ${status.loaded_satellites || 0}
📊 Total Available: ${status.total_satellites || 0}
📐 Min Elevation: 10°
🕒 Last Update: ${status.last_update ? new Date(status.last_update).toLocaleString() : 'Never'}
${status.next_update ? `🕒 Next Update: ${new Date(status.next_update * 1000).toLocaleString()}` : ''}
${status.loading ? `\n⏳ Loading Progress: ${status.progress}%` : ''}
${status.error ? `\n❌ Error: ${status.error}` : ''}

🎯 Service runs on port 5003
✅ Status: Satellite tracking separated from main API`;
                    
                    alert(details);
                })
                .catch(error => {
                    alert('Error fetching satellite details: ' + error.message);
                });
        }
        
        function toggleSatelliteTracking() {
            // Placeholder for toggle functionality
            alert('🛰️ Satellite tracking toggle functionality would be implemented here');
        }
        
        // Initialize satellite tracker when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start periodic updates for satellite data
            refreshSatelliteData();
            setInterval(refreshSatelliteData, 30000); // Update every 30 seconds
            
            // Start periodic updates for compass data
            refreshCompassData();
            setInterval(refreshCompassData, 2000); // Update every 2 seconds
        });
        
        // Motion Sensor Functions
        function refreshMotionData() {
            fetch('/api/motion/status')
                .then(response => response.json())
                .then(data => {
                    updateMotionWidget(data);
                })
                .catch(error => {
                    console.error('Error fetching motion data:', error);
                    document.getElementById('motion-connection-status').textContent = 'Error';
                    document.getElementById('motion-connection-status').style.color = '#dc3545';
                });
        }
        
        function updateMotionWidget(status) {
            // Update status indicator
            const statusEl = document.getElementById('motion-connection-status');
            if (status.running) {
                statusEl.textContent = 'Active';
                statusEl.style.color = '#28a745';
            } else {
                statusEl.textContent = status.hardware_available ? 'Inactive' : 'Hardware N/A';
                statusEl.style.color = '#dc3545';
            }
            
            // Update basic stats
            document.getElementById('motion-temperature').textContent = `${status.current_temperature || 0}°C`;
            
            // Fetch detailed motion data
            fetch('/api/motion/data')
                .then(response => response.json())
                .then(motionData => {
                    if (motionData.success) {
                        displayMotionData(motionData.data, motionData.summary);
                    } else {
                        displayMotionError(motionData.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching motion sensor data:', error);
                    displayMotionError('Failed to fetch motion data');
                });
        }
        
        function displayMotionData(data, summary) {
            const displayEl = document.getElementById('motion-data-display');
            
            // Update status and stability
            const motionStatus = data.motion_detected ? 'MOTION' : 'STABLE';
            document.getElementById('motion-status').textContent = motionStatus;
            document.getElementById('motion-stability').textContent = `${summary.stability_score || 0}%`;
            
            if (!data.acceleration) {
                displayEl.innerHTML = '<div class="motion-loading"><p>📱 No motion data available</p></div>';
                return;
            }
            
            const calibratedClass = data.calibrated ? 'calibrated' : 'uncalibrated';
            const statusClass = data.motion_detected ? 'status-motion' : 'status-stable';
            
            const html = `
                <div class="motion-data-item ${calibratedClass}">
                    <div class="flight-header">
                        <span>📱 MPU-6050 Sensor</span>
                        <span>${data.calibrated ? 'Calibrated' : 'Uncalibrated'}</span>
                    </div>
                    <div style="margin-top: 4px;">
                        <small>I2C Address: 0x68 | Sample Rate: 50Hz</small>
                    </div>
                </div>
                
                <div class="motion-data-item ${statusClass}">
                    <div class="flight-header">
                        <span>📐 Orientation</span>
                        <span>Tilt: ${data.tilt_angle || 0}°</span>
                    </div>
                    <div style="margin-top: 4px;">
                        <small>
                            Pitch: ${data.orientation?.pitch || 0}° | 
                            Roll: ${data.orientation?.roll || 0}° | 
                            Yaw: ${data.orientation?.yaw || 0}°
                        </small>
                    </div>
                </div>
                
                <div class="motion-data-item">
                    <div class="flight-header">
                        <span>⚡ Acceleration</span>
                        <span>${motionStatus}</span>
                    </div>
                    <div style="margin-top: 4px;">
                        <small>
                            X: ${data.acceleration?.x || 0} m/s² | 
                            Y: ${data.acceleration?.y || 0} m/s² | 
                            Z: ${data.acceleration?.z || 0} m/s²
                        </small>
                    </div>
                </div>
                
                <div class="motion-data-item">
                    <div class="flight-header">
                        <span>🌀 Gyroscope</span>
                        <span>Vib: ${data.vibration_level || 0}°/s</span>
                    </div>
                    <div style="margin-top: 4px;">
                        <small>
                            X: ${data.gyroscope?.x || 0}°/s | 
                            Y: ${data.gyroscope?.y || 0}°/s | 
                            Z: ${data.gyroscope?.z || 0}°/s
                        </small>
                    </div>
                </div>
            `;
            
            displayEl.innerHTML = html;
        }
        
        function displayMotionError(error) {
            const displayEl = document.getElementById('motion-data-display');
            displayEl.innerHTML = `<div class="motion-loading"><p>❌ ${error}</p><small>Check I2C connection and sensor wiring</small></div>`;
            
            // Reset stats
            document.getElementById('motion-status').textContent = 'Error';
            document.getElementById('motion-stability').textContent = '0%';
        }
        
        function calibrateMotionSensor() {
            if (confirm('Calibrate motion sensor? Keep the device stable during calibration.')) {
                fetch('/api/motion/calibrate', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('✅ Motion sensor calibrated successfully!');
                            refreshMotionData(); // Refresh data after calibration
                        } else {
                            alert('❌ Calibration failed: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('💥 Calibration error: ' + error.message);
                    });
            }
        }
        
        function showMotionDetails() {
            fetch('/api/motion/status')
                .then(response => response.json())
                .then(status => {
                    const details = `📱 Motion Sensor Details

📡 Connection Status: ${status.running ? 'Active' : 'Inactive'}
🔌 Hardware Available: ${status.hardware_available ? 'Yes' : 'No'}
📐 Calibrated: ${status.calibrated ? 'Yes' : 'No'}
📊 Sample Rate: ${status.sample_rate || 0} Hz
🌡️ Temperature: ${status.current_temperature || 0}°C
🕒 Last Update: ${status.last_update ? new Date(status.last_update).toLocaleString() : 'Never'}

⚙️ Configuration:
  I2C Address: ${status.i2c_address || '0x68'}
  Motion Threshold: ${status.motion_threshold || 0} m/s²
  Vibration Threshold: ${status.vibration_threshold || 0}°/s

✅ Status: ${status.enabled ? 'Enabled' : 'Disabled'}`;
                    
                    alert(details);
                })
                .catch(error => {
                    alert('Error fetching motion sensor details: ' + error.message);
                });
        }
        
        // Compass/MPU9250 Sensor Functions
        function refreshCompassData() {
            fetch('/api/sensor/data')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateCompassStatusBar(result.data);
                    } else {
                        console.error('Failed to fetch compass data:', result.error);
                        updateCompassStatusBar(null);
                    }
                })
                .catch(error => {
                    console.error('Error fetching compass data:', error);
                    updateCompassStatusBar(null);
                });
        }
        
        function updateCompassStatusBar(data) {
            const statusEl = document.getElementById('compass-status-bar');
            const indicatorEl = document.getElementById('compass-indicator-bar');
            
            if (!data) {
                // Error state
                statusEl.textContent = 'Error';
                statusEl.style.color = '#dc3545';
                indicatorEl.style.backgroundColor = '#dc3545';
                return;
            }
            
            // Update status text with compass heading
            const heading = data.compass?.heading || 0;
            const calibrated = data.compass?.calibrated || false;
            statusEl.textContent = `${Math.round(heading)}° ${calibrated ? '✓' : '⚠'}`;
            statusEl.style.color = calibrated ? '#28a745' : '#ffc107';
            indicatorEl.style.backgroundColor = calibrated ? '#28a745' : '#ffc107';
        }
        
        function showCompassDetails() {
            fetch('/api/sensor/status')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const status = result.status;
                        const details = `🧭 MPU9250 Compass Details

📡 Connection Status: ${status.running ? 'Active' : 'Inactive'}
🔌 Hardware Available: ${status.hardware_available ? 'Yes' : 'No'}
📐 Calibrated: ${status.calibrated ? 'Yes' : 'No'}
🧭 Compass Calibrated: ${status.compass_calibrated ? 'Yes' : 'No'}
📊 Sample Rate: ${status.sample_rate || 0} Hz
🌡️ Temperature: ${status.current_temperature || 0}°C
🕒 Last Update: ${status.last_update ? new Date(status.last_update).toLocaleString() : 'Never'}

⚙️ Configuration:
  I2C Addresses: ${status.i2c_addresses ? status.i2c_addresses.join(', ') : '0x68, 0x0C'}
  Motion Threshold: ${status.motion_threshold || 0} m/s²
  Vibration Threshold: ${status.vibration_threshold || 0}°/s
  Library: ${status.library || 'Unknown'}

✅ Status: ${status.enabled ? 'Enabled' : 'Disabled'}`;
                        
                        alert(details);
                    } else {
                        alert('Error fetching compass details: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error fetching compass details: ' + error.message);
                });
        }
        
        function calibrateCompass() {
            if (confirm('This will start magnetometer calibration. Rotate the device in 3D figure-8 patterns for 60 seconds. Continue?')) {
                fetch('/api/sensor/calibrate/magnetometer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: 60 })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('✅ Compass calibration completed!');
                        refreshCompassData(); // Refresh data after calibration
                    } else {
                        alert('❌ Calibration failed: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('💥 Calibration error: ' + error.message);
                });
            }
        }
        
        function setMagneticDeclination() {
            const declination = parseFloat(prompt('Enter magnetic declination for your location (degrees):') || '0');
            
            fetch('/api/sensor/compass/set_declination', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ declination: declination })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`✅ Magnetic declination set to ${declination}°`);
                    refreshCompassData();
                } else {
                    alert('❌ Setting declination failed: ' + result.error);
                }
            })
            .catch(error => {
                alert('💥 Error setting magnetic declination: ' + error.message);
            });
        }
        
        // Initialize motion sensor when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start periodic updates for motion sensor data
            refreshMotionData();
            setInterval(refreshMotionData, 2000); // Update every 2 seconds
        });
    </script>
    <!-- Image Modal -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modal-image" class="image-modal-content" onclick="event.stopPropagation()">
    </div>

</body>
</html>
