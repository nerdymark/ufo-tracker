<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFO Tracker - Trajectory Overlay Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .camera-views {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .camera-view {
            position: relative;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
            min-height: 400px;
            background: #111;
        }
        .camera-view h3 {
            margin: 0;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controls h3 {
            margin-top: 0;
        }
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 10px 0;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: #fff;
            cursor: pointer;
            text-align: center;
        }
        .btn:hover {
            background: #555;
        }
        .btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        .status {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        .status h4 {
            margin-top: 0;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UFO Tracker - Trajectory Overlay Test</h1>
        
        <div class="controls">
            <h3>Trajectory Overlay Controls</h3>
            <div class="control-group">
                <button class="btn" id="toggle-ir-overlay">Enable IR Overlay</button>
                <button class="btn" id="toggle-hq-overlay">Enable HQ Overlay</button>
                <button class="btn" id="refresh-sensor">Refresh Sensor Data</button>
                <button class="btn" id="test-projections">Test Projections</button>
            </div>
        </div>
        
        <div class="camera-views">
            <div class="camera-view">
                <h3>IR Camera (35° × 26° FOV)</h3>
                <img class="camera-image" id="ir-image" src="http://localhost:5001/ir_frame" alt="IR Camera">
                <div id="ir-overlay-container"></div>
            </div>
            <div class="camera-view">
                <h3>HQ Camera (45° × 34° FOV)</h3>
                <img class="camera-image" id="hq-image" src="http://localhost:5001/hq_frame" alt="HQ Camera">
                <div id="hq-overlay-container"></div>
            </div>
        </div>
        
        <div class="status">
            <h4>Sensor Status</h4>
            <div id="sensor-status">Loading...</div>
        </div>
    </div>

    <script src="/static/js/trajectory-overlay.js"></script>
    <script>
        let irOverlay = null;
        let hqOverlay = null;
        let sensorData = {};
        
        function initOverlays() {
            // Initialize trajectory overlays for both cameras
            irOverlay = new TrajectoryOverlay('ir-overlay-container', 'ir');
            hqOverlay = new TrajectoryOverlay('hq-overlay-container', 'hq');
        }
        
        async function refreshSensorData() {
            try {
                const response = await fetch('/api/sensor/mpu9250');
                const data = await response.json();
                
                if (data.success) {
                    sensorData = data.data;
                    updateSensorStatus();
                    updateOverlays();
                } else {
                    document.getElementById('sensor-status').innerHTML = 
                        `<span style="color: #ff6666;">Error: ${data.error}</span>`;
                }
            } catch (error) {
                document.getElementById('sensor-status').innerHTML = 
                    `<span style="color: #ff6666;">Fetch Error: ${error.message}</span>`;
            }
        }
        
        function updateSensorStatus() {
            const status = document.getElementById('sensor-status');
            const timestamp = new Date(sensorData.timestamp).toLocaleTimeString();
            
            status.innerHTML = `
                <strong>Last Update:</strong> ${timestamp}<br>
                <strong>Compass:</strong> ${sensorData.compass.true_heading.toFixed(1)}° true heading 
                (calibrated: ${sensorData.compass.calibrated})<br>
                <strong>Pitch:</strong> ${sensorData.orientation.pitch.toFixed(1)}° 
                <strong>Roll:</strong> ${sensorData.orientation.roll.toFixed(1)}° 
                <strong>Yaw:</strong> ${sensorData.orientation.yaw.toFixed(1)}°<br>
                <strong>Tilt Angle:</strong> ${sensorData.tilt_angle.toFixed(1)}°<br>
                <strong>Motion Detected:</strong> ${sensorData.motion_detected}
            `;
        }
        
        function updateOverlays() {
            if (sensorData.compass && sensorData.orientation) {
                // Update both overlays with current sensor data
                if (irOverlay) {
                    irOverlay.setCompass(sensorData.compass.true_heading, sensorData.compass.calibrated);
                    irOverlay.setOrientation(
                        sensorData.orientation.pitch,
                        sensorData.orientation.roll,
                        sensorData.orientation.yaw
                    );
                }
                
                if (hqOverlay) {
                    hqOverlay.setCompass(sensorData.compass.true_heading, sensorData.compass.calibrated);
                    hqOverlay.setOrientation(
                        sensorData.orientation.pitch,
                        sensorData.orientation.roll,
                        sensorData.orientation.yaw
                    );
                }
            }
        }
        
        function testProjections() {
            // Create test objects at different elevations to demonstrate pitch compensation
            if (irOverlay && sensorData.compass && sensorData.orientation) {
                console.log('Testing projections with current sensor data:');
                console.log('Pitch:', sensorData.orientation.pitch, '(camera tilt up/down)');
                console.log('Compass:', sensorData.compass.true_heading);
                
                // Test objects at different elevations relative to horizon
                const heading = sensorData.compass.true_heading;
                const testObjects = [
                    { azimuth: heading, elevation: -20, name: 'Below Horizon (-20°)', color: '#ff4444' },
                    { azimuth: heading, elevation: 0, name: 'Horizon (0°)', color: '#ffff44' },
                    { azimuth: heading, elevation: 20, name: 'Above Horizon (+20°)', color: '#44ff44' },
                    { azimuth: heading, elevation: 40, name: 'High Elevation (+40°)', color: '#4444ff' },
                    { azimuth: heading + 15, elevation: 10, name: '15° Right, 10° Up', color: '#ff44ff' },
                    { azimuth: heading - 15, elevation: 10, name: '15° Left, 10° Up', color: '#44ffff' }
                ];
                
                console.log('--- Projection Test Results ---');
                testObjects.forEach(obj => {
                    const screenPos = irOverlay.projectToScreen(obj.azimuth, obj.elevation);
                    const compensatedEl = obj.elevation + sensorData.orientation.pitch;
                    console.log(`${obj.name}:`);
                    console.log(`  Raw: Az=${obj.azimuth.toFixed(1)}°, El=${obj.elevation}°`);
                    console.log(`  Compensated El: ${compensatedEl.toFixed(1)}° (${obj.elevation}° + ${sensorData.orientation.pitch.toFixed(1)}° pitch)`);
                    console.log(`  Screen: ${screenPos ? `(${screenPos.x.toFixed(0)}, ${screenPos.y.toFixed(0)})` : 'not visible'}`);
                    console.log('');
                });
                
                // Add visual markers directly to the overlay canvas for debugging
                drawTestMarkers(irOverlay, testObjects);
            }
        }
        
        function drawTestMarkers(overlay, testObjects) {
            if (!overlay.ctx) return;
            
            overlay.ctx.save();
            
            testObjects.forEach(obj => {
                const screenPos = overlay.projectToScreen(obj.azimuth, obj.elevation);
                if (screenPos) {
                    // Draw test marker
                    overlay.ctx.fillStyle = obj.color;
                    overlay.ctx.beginPath();
                    overlay.ctx.arc(screenPos.x, screenPos.y, 6, 0, 2 * Math.PI);
                    overlay.ctx.fill();
                    
                    // Draw label
                    overlay.ctx.fillStyle = obj.color;
                    overlay.ctx.font = '10px monospace';
                    overlay.ctx.fillText(obj.name, screenPos.x + 10, screenPos.y + 4);
                }
            });
            
            overlay.ctx.restore();
        }
        
        // Event listeners
        document.getElementById('toggle-ir-overlay').addEventListener('click', function() {
            if (irOverlay) {
                const enabled = !irOverlay.projectionEnabled;
                irOverlay.enableProjection(enabled);
                this.textContent = enabled ? 'Disable IR Overlay' : 'Enable IR Overlay';
                this.classList.toggle('active', enabled);
            }
        });
        
        document.getElementById('toggle-hq-overlay').addEventListener('click', function() {
            if (hqOverlay) {
                const enabled = !hqOverlay.projectionEnabled;
                hqOverlay.enableProjection(enabled);
                this.textContent = enabled ? 'Disable HQ Overlay' : 'Enable HQ Overlay';
                this.classList.toggle('active', enabled);
            }
        });
        
        document.getElementById('refresh-sensor').addEventListener('click', refreshSensorData);
        document.getElementById('test-projections').addEventListener('click', testProjections);
        
        // Refresh camera images periodically
        function refreshImages() {
            const timestamp = Date.now();
            document.getElementById('ir-image').src = `http://localhost:5001/ir_frame?t=${timestamp}`;
            document.getElementById('hq-image').src = `http://localhost:5001/hq_frame?t=${timestamp}`;
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initOverlays();
            refreshSensorData();
            
            // Refresh sensor data every 5 seconds
            setInterval(refreshSensorData, 5000);
            
            // Refresh images every 2 seconds
            setInterval(refreshImages, 2000);
        });
    </script>
</body>
</html>